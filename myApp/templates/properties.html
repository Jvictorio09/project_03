{% extends 'base_internal.html' %}
{% load static %}
{% load humanize %}

{% block title %}Properties - KaTek AI{% endblock %}

{% block content %}
<style>
  /* Force readable colors for native select dropdowns (Windows/Chrome, etc.) */
  select option,
  select optgroup {
    color: #0b0e14 !important;           /* slate-900: readable text */
    background-color: #ffffff !important; /* white dropdown background */
  }

  /* Placeholder/empty option looks muted */
  select option[value=""] {
    color: #94a3b8 !important; /* slate-400 */
  }

  /* High-contrast when using prefers-color-scheme: dark */
  @media (prefers-color-scheme: dark) {
    select option,
    select optgroup {
      color: #0b0e14 !important;
      background-color: #ffffff !important;
    }
  }
</style>

<div class="relative">
  <!-- Ambient gradient glow -->
  <div class="pointer-events-none absolute inset-x-0 -top-28 h-48 bg-gradient-to-r from-indigo-500/20 via-fuchsia-500/20 to-cyan-400/20 blur-3xl"></div>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 lg:py-14">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8 lg:mb-10">
      <h1 class="text-3xl sm:text-4xl font-semibold tracking-tight text-white">Properties</h1>

      <div class="flex flex-col sm:flex-row gap-3 sm:items-center">
        <!-- Search -->
        <div class="relative min-w-[280px]">
          <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-white/50 text-sm"></i>
          <input id="property-search" type="text" placeholder="Search properties..." class="w-full pl-9 pr-3 py-2.5 bg-white/5 border border-white/20 rounded-md text-sm text-white placeholder-white/50 outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/20" />
        </div>

        {% load extras %}
        {% is_feature_enabled 'property_creation' as property_creation_enabled %}
        {% if property_creation_enabled %}
          <a href="#" 
             hx-get="{% url 'add_property_modal' %}" 
             hx-target="#add-property-modal .modal-body" 
             hx-trigger="click"
             onclick="event.preventDefault(); setTimeout(() => document.getElementById('add-property-modal').classList.remove('hidden'), 100);"
             class="inline-flex items-center gap-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 active:bg-indigo-700 px-4 py-2.5 text-sm font-medium text-white shadow-lg shadow-indigo-900/30 transition">
            <i class="fas fa-plus"></i>
            Add Property
          </a>
        {% else %}
          {% get_disabled_tooltip 'property_creation' as property_creation_tooltip %}
          <span title="{{ property_creation_tooltip }}" class="inline-flex items-center gap-2 rounded-lg bg-white/10 px-4 py-2.5 text-sm font-medium text-white/60 border border-white/10 cursor-not-allowed">
            <i class="fas fa-plus"></i>
            Add Property
          </span>
        {% endif %}
      </div>
    </div>

    <!-- Filters -->
    <section class="bg-white/5 border border-white/10 rounded-2xl shadow-2xl shadow-black/20 backdrop-blur-xl p-5 sm:p-6 mb-8">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-base sm:text-lg font-semibold text-white">Filters</h3>
        <button type="button" class="text-sm text-white/70 hover:text-white" onclick="clearFilters()">Clear All</button>
      </div>

      <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
        <label class="block">
          <span class="block text-sm font-medium text-white/80 mb-1">City</span>
          <select id="city-filter" class="w-full bg-white/5 border border-white/20 rounded-md px-3 py-2 text-sm text-white outline-none focus:border-indigo-500" style="color-scheme: dark;">
            <option value="">All Cities</option>
            {% for city_option in cities %}
              <option value="{{ city_option }}" {% if current_filters.city == city_option %}selected{% endif %}>{{ city_option }}</option>
            {% endfor %}
          </select>
        </label>

        <label class="block">
          <span class="block text-sm font-medium text-white/80 mb-1">Price Range</span>
          <select id="price-filter" class="w-full bg-white/5 border border-white/20 rounded-md px-3 py-2 text-sm text-white outline-none focus:border-indigo-500" style="color-scheme: dark;">
            <option value="">All Prices</option>
            <option value="0-300000" {% if current_filters.price_max == '300000' %}selected{% endif %}>Under $300K</option>
            <option value="300000-500000" {% if current_filters.price_min == '300000' and current_filters.price_max == '500000' %}selected{% endif %}>$300K - $500K</option>
            <option value="500000-1000000" {% if current_filters.price_min == '500000' and current_filters.price_max == '1000000' %}selected{% endif %}>$500K - $1M</option>
            <option value="1000000+" {% if current_filters.price_min == '1000000' %}selected{% endif %}>Over $1M</option>
          </select>
        </label>

        <label class="block">
          <span class="block text-sm font-medium text-white/80 mb-1">Bedrooms</span>
          <select id="beds-filter" class="w-full bg-white/5 border border-white/20 rounded-md px-3 py-2 text-sm text-white outline-none focus:border-indigo-500" style="color-scheme: dark;">
            <option value="">Any</option>
            <option value="1" {% if current_filters.beds == '1' %}selected{% endif %}>1+</option>
            <option value="2" {% if current_filters.beds == '2' %}selected{% endif %}>2+</option>
            <option value="3" {% if current_filters.beds == '3' %}selected{% endif %}>3+</option>
            <option value="4" {% if current_filters.beds == '4' %}selected{% endif %}>4+</option>
          </select>
        </label>

        <label class="block">
          <span class="block text-sm font-medium text-white/80 mb-1">Status</span>
          <select id="status-filter" class="w-full bg-white/5 border border-white/20 rounded-md px-3 py-2 text-sm text-white outline-none focus:border-indigo-500" style="color-scheme: dark;">
            <option value="">All Status</option>
            <option value="active">Active</option>
            <option value="pending">Pending</option>
            <option value="draft">Draft</option>
          </select>
        </label>
      </div>
    </section>

    <!-- Properties Table -->
    <section class="bg-white/5 border border-white/10 rounded-2xl shadow-2xl shadow-black/20 backdrop-blur-xl overflow-hidden">
      <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-3 px-5 sm:px-6 py-5 border-b border-white/10">
        <h3 class="text-lg font-semibold text-white" id="properties-count">All Properties ({{ total_count|default:0 }})</h3>
        <div class="flex flex-wrap items-center gap-2">
          <div class="flex items-center gap-2">
            <select id="bulk-action" class="bg-white/5 border border-white/20 rounded-md px-3 py-2 text-sm text-white outline-none">
              <option value="">Bulk Actions</option>
              <option value="sync">Sync Estimates</option>
              <option value="publish">Publish to Site</option>
              <option value="push">Push to AI Brain</option>
              <option value="archive">Archive</option>
            </select>
            <button type="button" onclick="applyBulkAction()" class="rounded-md bg-white/10 hover:bg-white/15 px-3 py-2 text-sm text-white border border-white/10">Apply</button>
          </div>
          <button type="button" onclick="exportProperties()" class="rounded-md bg-white/10 hover:bg-white/15 px-3 py-2 text-sm text-white border border-white/10">
            <i class="fas fa-download mr-1.5"></i>
            Export
          </button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full align-middle">
          <thead class="bg-white/5 border-b border-white/10">
            <tr class="table-header-row">
              <th class="text-left text-xs font-semibold uppercase tracking-wide text-white/70 px-6 py-3">
                <input id="select-all" type="checkbox" class="align-middle">
              </th>
              <th class="text-left text-xs font-semibold uppercase tracking-wide text-white/70 px-6 py-3">Property</th>
              <th class="text-left text-xs font-semibold uppercase tracking-wide text-white/70 px-6 py-3">Price</th>
              <th class="text-left text-xs font-semibold uppercase tracking-wide text-white/70 px-6 py-3">Est. Value</th>
              <th class="text-left text-xs font-semibold uppercase tracking-wide text-white/70 px-6 py-3">Updated</th>
              <th class="text-left text-xs font-semibold uppercase tracking-wide text-white/70 px-6 py-3">Status</th>
              <th class="text-left text-xs font-semibold uppercase tracking-wide text-white/70 px-6 py-3">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-white/5">
            {% for property in page_obj %}
            <tr class="table-row hover:bg-white/5 transition">
              <td class="px-6 py-4 align-top">
                <input type="checkbox" class="property-checkbox align-middle" value="{{ property.id }}">
              </td>
              <td class="px-6 py-4">
                <div class="flex items-center gap-3">
                  <div class="w-[60px] h-10 rounded-md bg-gradient-to-br from-white/10 to-white/5 border border-white/10 grid place-items-center text-white/60 text-lg">
                    <i class="fas fa-home"></i>
                  </div>
                  <div class="min-w-0">
                    <h4 class="text-sm font-semibold text-white truncate">{{ property.title }}</h4>
                    <p class="text-xs text-white/60">{{ property.city }}, {{ property.area }}</p>
                    <div class="flex flex-wrap items-center gap-3 mt-1 text-xs text-white/50">
                      <span class="inline-flex items-center gap-1"><i class="fas fa-bed"></i> {{ property.beds }} beds</span>
                      <span class="inline-flex items-center gap-1"><i class="fas fa-bath"></i> {{ property.baths }} baths</span>
                    </div>
                  </div>
                </div>
              </td>
              <td class="px-6 py-4 align-top">
                <div class="text-sm font-semibold text-indigo-400">${{ property.price_amount|floatformat:0|intcomma }}</div>
              </td>
              <td class="px-6 py-4 align-top">
                <div class="text-sm font-semibold text-indigo-400">${{ property.price_amount|floatformat:0|intcomma }}</div>
                <div class="text-[11px] text-white/50">Est. AVM</div>
              </td>
              <td class="px-6 py-4 align-top">
                <div class="text-[13px] text-white/90">{{ property.created_at|date:"M d, Y" }}</div>
                <div class="text-[11px] text-white/50">{{ property.created_at|timesince }} ago</div>
              </td>
              <td class="px-6 py-4 align-top">
                <span class="inline-flex items-center rounded-md border px-2 py-1 text-[10px] font-semibold uppercase tracking-wide
                             bg-emerald-500/15 border-emerald-400/30 text-emerald-300">Active</span>
              </td>
              <td class="px-6 py-4 align-top">
                <div class="flex items-center gap-2">
                  <button class="rounded-md bg-white/5 hover:bg-white/10 border border-white/15 px-2.5 py-2 text-xs text-white/80 transition-colors" 
                          title="Edit"
                          onclick="event.preventDefault(); document.getElementById('add-property-modal').classList.remove('hidden');"
                          hx-get="{% url 'edit_property_modal' property.id %}"
                          hx-target="#add-property-modal .modal-body"
                          hx-trigger="click">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="rounded-md bg-white/5 hover:bg-white/10 border border-white/15 px-2.5 py-2 text-xs text-white/80 transition-colors" 
                          title="Duplicate" 
                          onclick="showNotification('Duplicate functionality coming soon', 'info')">
                    <i class="fas fa-copy"></i>
                  </button>
                  <button class="hide-property-btn rounded-md bg-white/5 hover:bg-red-500/20 border border-white/15 hover:border-red-500/50 px-2.5 py-2 text-xs text-white/80 hover:text-red-400 transition-colors" 
                          title="Hide from view" 
                          type="button"
                          data-property-id="{{ property.id }}"
                          onclick="event.preventDefault(); event.stopPropagation(); console.log('onclick fired!', '{{ property.id }}'); hideProperty('{{ property.id }}', this); return false;">
                    <i class="fas fa-eye-slash"></i>
                  </button>
                  <button class="rounded-md bg-indigo-600 hover:bg-indigo-500 active:bg-indigo-700 px-2.5 py-2 text-xs text-white transition-colors" 
                          title="Push to AI Brain" 
                          onclick="showNotification('Push to AI Brain functionality coming soon', 'info')">
                    <i class="fas fa-brain"></i>
                  </button>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr class="table-row">
              <td colspan="7" class="px-6 py-16">
                <div class="flex flex-col items-center gap-3">
                  <i class="fas fa-home text-4xl text-white/40"></i>
                  <h3 class="text-white text-lg font-medium">No properties yet</h3>
                  <p class="text-white/60 text-sm">Import your first 20 properties in under 2 minutes</p>
                  <button 
                    onclick="document.getElementById('add-property-modal').classList.remove('hidden');"
                    hx-get="{% url 'add_property_modal' %}"
                    hx-target="#add-property-modal .modal-body"
                    hx-trigger="click"
                    class="inline-flex items-center gap-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 active:bg-indigo-700 px-4 py-2.5 text-sm font-medium text-white shadow-lg shadow-indigo-900/30 transition">
                    <i class="fas fa-upload"></i>
                    Import Properties
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      {% if page_obj.paginator.num_pages > 1 %}
      <div class="flex flex-wrap items-center justify-center gap-2 px-5 sm:px-6 py-5 border-t border-white/10">
        {% comment %}Build query string preserving filters, excluding page{% endcomment %}
        {% url 'properties' as base_url %}
        
        {% comment %}Previous button{% endcomment %}
        {% if page_obj.has_previous %}
          <a href="{{ base_url }}?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}" 
             class="rounded-md bg-white/5 hover:bg-white/10 border border-white/15 px-3 py-2 text-sm text-white/80 transition-colors">
            <i class="fas fa-chevron-left"></i>
          </a>
        {% else %}
          <span class="rounded-md bg-white/5 border border-white/15 px-3 py-2 text-sm text-white/40 cursor-not-allowed opacity-50">
            <i class="fas fa-chevron-left"></i>
          </span>
        {% endif %}

        {% comment %}Page numbers - show max 7 pages around current{% endcomment %}
        {% for num in page_obj.paginator.page_range %}
          {% if num == page_obj.number %}
            <span class="rounded-md bg-indigo-600 px-3 py-2 text-sm text-white font-semibold">{{ num }}</span>
          {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
            <a href="{{ base_url }}?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}" 
               class="rounded-md bg-white/5 hover:bg-white/10 border border-white/15 px-3 py-2 text-sm text-white/80 transition-colors">
              {{ num }}
            </a>
          {% elif num == 1 or num == page_obj.paginator.num_pages %}
            <a href="{{ base_url }}?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}" 
               class="rounded-md bg-white/5 hover:bg-white/10 border border-white/15 px-3 py-2 text-sm text-white/80 transition-colors">
              {{ num }}
            </a>
          {% elif num == page_obj.number|add:'-4' or num == page_obj.number|add:'4' %}
            <span class="px-2 text-white/40">...</span>
          {% endif %}
        {% endfor %}

        {% comment %}Next button{% endcomment %}
        {% if page_obj.has_next %}
          <a href="{{ base_url }}?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}" 
             class="rounded-md bg-white/5 hover:bg-white/10 border border-white/15 px-3 py-2 text-sm text-white/80 transition-colors">
            <i class="fas fa-chevron-right"></i>
          </a>
        {% else %}
          <span class="rounded-md bg-white/5 border border-white/15 px-3 py-2 text-sm text-white/40 cursor-not-allowed opacity-50">
            <i class="fas fa-chevron-right"></i>
          </span>
        {% endif %}

        {% comment %}Results count{% endcomment %}
        <span class="text-sm text-white/60 ml-2">
          Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ total_count }} properties
        </span>
      </div>
      {% endif %}
    </section>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Helper function to get CSRF token from cookies (global)
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // Helper function to show notifications
  function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    const colors = {
      'success': 'bg-emerald-500 text-white',
      'error': 'bg-red-500 text-white',
      'info': 'bg-blue-500 text-white',
      'warning': 'bg-yellow-500 text-white'
    };
    notification.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg transition-all duration-300 ${
      colors[type] || colors['success']
    }`;
    notification.textContent = message;
    notification.style.opacity = '0';
    notification.style.transform = 'translateX(100%)';
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
      notification.style.opacity = '1';
      notification.style.transform = 'translateX(0)';
    }, 10);
    
    // Animate out
    setTimeout(() => {
      notification.style.opacity = '0';
      notification.style.transform = 'translateX(100%)';
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }

  function hideProperty(propertyId, button) {
    console.log('=== hideProperty called ===');
    console.log('Property ID:', propertyId);
    console.log('Button:', button);
    
    if (!propertyId || propertyId === 'undefined' || propertyId === 'null') {
      console.error('Property ID is missing or invalid:', propertyId);
      showNotification('Error: Property ID is missing', 'error');
      return false;
    }
    
    if (!button) {
      console.error('Button element is missing');
      showNotification('Error: Button element is missing', 'error');
      return false;
    }
    
    if (!confirm('Hide this property from your view? It will still be visible to other users and you can restore it later.')) {
      console.log('User cancelled');
      return false;
    }
    
    const csrfToken = getCookie('csrftoken');
    console.log('CSRF Token:', csrfToken ? 'Found (' + csrfToken.substring(0, 10) + '...)' : 'NOT FOUND');
    
    const url = `/api/properties/${propertyId}/hide/`;
    console.log('Request URL:', url);
    console.log('Making fetch request...');
    
    // Disable button during request
    button.disabled = true;
    button.style.opacity = '0.5';
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken || '',
        'Content-Type': 'application/json',
      },
      credentials: 'same-origin'
    })
    .then(response => {
      console.log('Response status:', response.status);
      if (!response.ok) {
        return response.text().then(text => {
          console.error('Error response:', text);
          throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
        });
      }
      return response.json();
    })
    .then(data => {
      console.log('Success data:', data);
      // Restore button
      button.disabled = false;
      button.style.opacity = '1';
      button.innerHTML = originalText;
      
      if (data.success) {
        // Remove the row from the table with animation
        const row = button.closest('tr');
        if (row) {
          row.style.transition = 'opacity 0.3s, transform 0.3s';
          row.style.opacity = '0';
          row.style.transform = 'translateX(-20px)';
          setTimeout(() => {
            row.remove();
            // Update property count
            const countEl = document.getElementById('properties-count');
            if (countEl) {
              const match = countEl.textContent.match(/\((\d+)\)/);
              if (match) {
                const newCount = Math.max(0, parseInt(match[1]) - 1);
                countEl.textContent = countEl.textContent.replace(/\(\d+\)/, `(${newCount})`);
              }
            }
            
            // Show success message
            showNotification('Property hidden from your view', 'success');
            
            // If no properties left, reload page to show empty state
            const remainingRows = document.querySelectorAll('.table-row');
            if (remainingRows.length === 0) {
              setTimeout(() => window.location.reload(), 500);
            }
          }, 300);
        }
      } else {
        showNotification(data.message || 'Failed to hide property. Please try again.', 'error');
      }
    })
    .catch(error => {
      console.error('=== FETCH ERROR ===');
      console.error('Error details:', error);
      console.error('Error message:', error.message);
      console.error('Error stack:', error.stack);
      showNotification('An error occurred: ' + error.message, 'error');
      // Re-enable button on error
      button.disabled = false;
      button.style.opacity = '1';
      button.innerHTML = originalText;
    });
    
    return false;
  }
  
  // Make function globally available
  window.hideProperty = hideProperty;
  window.showNotification = showNotification;
  window.getCookie = getCookie;

  document.addEventListener('DOMContentLoaded', function () {
    // Search functionality
    const searchInput = document.getElementById('property-search');
    searchInput?.addEventListener('input', function () {
      const term = this.value.toLowerCase();
      const rows = document.querySelectorAll('.table-row');
      rows.forEach(row => {
        const text = row.textContent?.toLowerCase() || '';
        row.style.display = text.includes(term) ? '' : 'none';
      });
    });

    // Filters
    ['city-filter', 'price-filter', 'beds-filter', 'status-filter'].forEach(id => {
      const el = document.getElementById(id);
      el?.addEventListener('change', applyFilters);
    });

    // Select all
    const selectAll = document.getElementById('select-all');
    const propBoxes = document.querySelectorAll('.property-checkbox');

    selectAll?.addEventListener('change', function () {
      propBoxes.forEach(cb => { cb.checked = selectAll.checked; });
    });

    propBoxes.forEach(cb => {
      cb.addEventListener('change', function () {
        const checked = document.querySelectorAll('.property-checkbox:checked');
        if (selectAll) selectAll.checked = (checked.length === propBoxes.length);
      });
    });
    
    // Event delegation for hide buttons (fallback - only if onclick doesn't work)
    document.addEventListener('click', function(e) {
      // Check if clicked element is the hide button or its icon
      const hideBtn = e.target.closest('.hide-property-btn');
      const isIcon = e.target.classList.contains('fa-eye-slash') && e.target.closest('.hide-property-btn');
      
      if (hideBtn && !hideBtn.hasAttribute('data-click-handled')) {
        // Mark as handled to prevent double-firing
        hideBtn.setAttribute('data-click-handled', 'true');
        setTimeout(() => hideBtn.removeAttribute('data-click-handled'), 100);
        
        e.preventDefault();
        e.stopPropagation();
        const propertyId = hideBtn.getAttribute('data-property-id');
        console.log('Event delegation caught click on hide button');
        console.log('Property ID from data attribute:', propertyId);
        console.log('Is icon click:', isIcon);
        
        if (propertyId && typeof hideProperty === 'function') {
          console.log('Calling hideProperty via event delegation');
          hideProperty(propertyId, hideBtn);
        } else {
          console.error('hideProperty function not available or property ID missing');
          console.error('Property ID:', propertyId);
          console.error('hideProperty type:', typeof hideProperty);
          alert('Error: Unable to hide property. Please refresh the page and try again.');
        }
      }
    }, true); // Use capture phase
    
    // Test that functions are available
    console.log('Functions available:', {
      hideProperty: typeof hideProperty,
      showNotification: typeof showNotification,
      getCookie: typeof getCookie
    });
  });

  function applyFilters() {
    const city = document.getElementById('city-filter')?.value || '';
    const priceFilter = document.getElementById('price-filter')?.value || '';
    const beds = document.getElementById('beds-filter')?.value || '';
    const status = document.getElementById('status-filter')?.value || '';
    
    // Build query params
    const params = new URLSearchParams();
    if (city) params.set('city', city);
    if (beds) params.set('beds', beds);
    if (status) params.set('status', status);
    
    // Parse price range
    if (priceFilter) {
      if (priceFilter === '0-300000') {
        params.set('price_max', '300000');
      } else if (priceFilter === '300000-500000') {
        params.set('price_min', '300000');
        params.set('price_max', '500000');
      } else if (priceFilter === '500000-1000000') {
        params.set('price_min', '500000');
        params.set('price_max', '1000000');
      } else if (priceFilter === '1000000+') {
        params.set('price_min', '1000000');
      }
    }
    
    // Redirect to filtered page
    window.location.href = '{% url "properties" %}?' + params.toString();
  }
  
  function exportProperties() {
    // Get current filters to include in export
    const city = document.getElementById('city-filter')?.value || '';
    const priceFilter = document.getElementById('price-filter')?.value || '';
    const beds = document.getElementById('beds-filter')?.value || '';
    
    const params = new URLSearchParams();
    if (city) params.set('city', city);
    if (beds) params.set('beds', beds);
    if (priceFilter) params.set('price_range', priceFilter);
    
    // Build export URL
    const exportUrl = '{% url "export_properties" %}?' + params.toString();
    window.location.href = exportUrl;
  }

  function clearFilters() {
    window.location.href = '{% url "properties" %}';
  }


  // Helper function to get CSRF token from cookies (global)
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // Helper function to show notifications
  function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    const colors = {
      'success': 'bg-emerald-500 text-white',
      'error': 'bg-red-500 text-white',
      'info': 'bg-blue-500 text-white',
      'warning': 'bg-yellow-500 text-white'
    };
    notification.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg transition-all duration-300 ${
      colors[type] || colors['success']
    }`;
    notification.textContent = message;
    notification.style.opacity = '0';
    notification.style.transform = 'translateX(100%)';
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
      notification.style.opacity = '1';
      notification.style.transform = 'translateX(0)';
    }, 10);
    
    // Animate out
    setTimeout(() => {
      notification.style.opacity = '0';
      notification.style.transform = 'translateX(100%)';
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }

  function hideProperty(propertyId, button) {
    console.log('=== hideProperty called ===');
    console.log('Property ID:', propertyId);
    console.log('Button:', button);
    
    if (!propertyId || propertyId === 'undefined' || propertyId === 'null') {
      console.error('Property ID is missing or invalid:', propertyId);
      showNotification('Error: Property ID is missing', 'error');
      return false;
    }
    
    if (!button) {
      console.error('Button element is missing');
      showNotification('Error: Button element is missing', 'error');
      return false;
    }
    
    if (!confirm('Hide this property from your view? It will still be visible to other users and you can restore it later.')) {
      console.log('User cancelled');
      return false;
    }
    
    const csrfToken = getCookie('csrftoken');
    console.log('CSRF Token:', csrfToken ? 'Found (' + csrfToken.substring(0, 10) + '...)' : 'NOT FOUND');
    
    const url = `/api/properties/${propertyId}/hide/`;
    console.log('Request URL:', url);
    console.log('Making fetch request...');
    
    // Disable button during request
    button.disabled = true;
    button.style.opacity = '0.5';
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken || '',
        'Content-Type': 'application/json',
      },
      credentials: 'same-origin'
    })
    .then(response => {
      console.log('Response status:', response.status);
      if (!response.ok) {
        return response.text().then(text => {
          console.error('Error response:', text);
          throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
        });
      }
      return response.json();
    })
    .then(data => {
      console.log('Success data:', data);
      // Restore button
      button.disabled = false;
      button.style.opacity = '1';
      button.innerHTML = originalText;
      
      if (data.success) {
        // Remove the row from the table with animation
        const row = button.closest('tr');
        if (row) {
          row.style.transition = 'opacity 0.3s, transform 0.3s';
          row.style.opacity = '0';
          row.style.transform = 'translateX(-20px)';
          setTimeout(() => {
            row.remove();
            // Update property count
            const countEl = document.getElementById('properties-count');
            if (countEl) {
              const match = countEl.textContent.match(/\((\d+)\)/);
              if (match) {
                const newCount = Math.max(0, parseInt(match[1]) - 1);
                countEl.textContent = countEl.textContent.replace(/\(\d+\)/, `(${newCount})`);
              }
            }
            
            // Show success message
            showNotification('Property hidden from your view', 'success');
            
            // If no properties left, reload page to show empty state
            const remainingRows = document.querySelectorAll('.table-row');
            if (remainingRows.length === 0) {
              setTimeout(() => window.location.reload(), 500);
            }
          }, 300);
        }
      } else {
        showNotification(data.message || 'Failed to hide property. Please try again.', 'error');
      }
    })
    .catch(error => {
      console.error('=== FETCH ERROR ===');
      console.error('Error details:', error);
      console.error('Error message:', error.message);
      console.error('Error stack:', error.stack);
      showNotification('An error occurred: ' + error.message, 'error');
      // Re-enable button on error
      button.disabled = false;
      button.style.opacity = '1';
      button.innerHTML = originalText;
    });
  }
  
  // Make function globally available
  window.hideProperty = hideProperty;
</script>

<!-- Add Property Modal (HTMX target) -->
<div id="add-property-modal" class="fixed inset-0 z-50 hidden overflow-y-auto">
  <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
    <!-- Background overlay -->
    <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity" onclick="document.getElementById('add-property-modal').classList.add('hidden');"></div>
    
    <!-- Modal panel -->
    <div class="inline-block align-bottom bg-slate-800 rounded-xl border border-white/10 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
      <div class="bg-slate-800 px-6 pt-6 pb-6">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-xl font-bold text-white">Add New Property</h3>
          <button type="button" class="text-gray-400 hover:text-white transition-colors" onclick="document.getElementById('add-property-modal').classList.add('hidden');">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        <div class="modal-body">
          <!-- Content will be loaded here via HTMX -->
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // HTMX event listeners for modal
  document.body.addEventListener('htmx:afterSwap', function(event) {
    if (event.detail.target.id === 'add-property-modal' || event.detail.target.classList.contains('modal-body')) {
      const modal = document.getElementById('add-property-modal');
      if (modal) {
        modal.classList.remove('hidden');
      }
    }
  });
  
  // HTMX error handling
  document.body.addEventListener('htmx:responseError', function(event) {
    const target = event.detail.target;
    const status = event.detail.xhr.status;
    const statusText = event.detail.xhr.statusText;
    
    console.error('HTMX Response Error:', status, statusText);
    
    // Show toast notification
    if (typeof showNotification === 'function') {
      showNotification(`Error ${status}: ${statusText}. Please try again.`, 'error');
    }
    
    // Inject error fragment if target is modal body
    if (target.classList.contains('modal-body')) {
      const errorHtml = `
        <div class="error-container bg-red-500/20 border border-red-500/50 rounded-lg p-6">
          <div class="flex items-start gap-4">
            <i class="fas fa-exclamation-triangle text-2xl text-red-400 flex-shrink-0 mt-1"></i>
            <div class="flex-1">
              <h3 class="text-lg font-semibold text-red-400 mb-2">Error</h3>
              <p class="text-red-300 mb-2">Unable to load form. Please refresh and try again.</p>
              <p class="text-xs text-red-400">Status: ${status} ${statusText}</p>
              <div class="mt-4">
                <button 
                  onclick="document.getElementById('add-property-modal').classList.add('hidden');"
                  class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors text-sm">
                  Close
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      target.innerHTML = errorHtml;
    }
  });
  
  document.body.addEventListener('htmx:sendError', function(event) {
    console.error('HTMX Send Error:', event.detail);
    if (typeof showNotification === 'function') {
      showNotification('Network error. Please check your connection and try again.', 'error');
    }
  });
  
  // Handle 422 (validation errors) specially
  document.body.addEventListener('htmx:afterRequest', function(event) {
    if (event.detail.xhr.status === 422) {
      // Validation errors are handled by the server response
      if (typeof showNotification === 'function') {
        showNotification('Please check the form for errors.', 'warning');
      }
    }
  });
</script>

<script src="{% static 'js/modal.js' %}"></script>
{% endblock %}
