{% extends 'base_internal.html' %}
{% load static %}

{% block title %}Settings - KaTek AI{% endblock %}

{# No extra_css — everything is Tailwind utilities #}
{% block extra_css %}{% endblock %}

{% block content %}
<div class="mx-auto max-w-[1200px] px-4 py-10 min-h-[calc(100vh-80px)]">
  <!-- Header -->
  <header class="mb-10">
    <h1 class="text-2xl font-bold text-white/90">Settings</h1>
    <p class="text-sm text-white/60">Manage your account, security, notifications, and API keys.</p>
  </header>

  <div class="grid gap-8 lg:grid-cols-[320px_1fr]">
    <!-- Sidebar -->
    <aside class="rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl p-6 h-fit">
      <nav class="space-y-1" aria-label="Settings navigation">
        <a href="#profile" data-link class="group flex items-center gap-3 rounded-xl px-4 py-3 text-sm font-medium text-white/70 hover:text-white hover:bg-white/10 transition">
          <i class="fas fa-user text-white/50 group-hover:text-white"></i>
          <span>Profile</span>
        </a>
        <a href="#security" data-link class="group flex items-center gap-3 rounded-xl px-4 py-3 text-sm font-medium text-white/70 hover:text-white hover:bg-white/10 transition">
          <i class="fas fa-shield-alt text-white/50 group-hover:text-white"></i>
          <span>Security</span>
        </a>
        <a href="#notifications" data-link class="group flex items-center gap-3 rounded-xl px-4 py-3 text-sm font-medium text-white/70 hover:text-white hover:bg-white/10 transition">
          <i class="fas fa-bell text-white/50 group-hover:text-white"></i>
          <span>Notifications</span>
        </a>
        <a href="#billing" data-link class="group flex items-center gap-3 rounded-xl px-4 py-3 text-sm font-medium text-white/70 hover:text-white hover:bg-white/10 transition">
          <i class="fas fa-credit-card text-white/50 group-hover:text-white"></i>
          <span>Billing</span>
        </a>
        <a href="#email" data-link class="group flex items-center gap-3 rounded-xl px-4 py-3 text-sm font-medium text-white/70 hover:text-white hover:bg-white/10 transition">
          <i class="fas fa-envelope text-white/50 group-hover:text-white"></i>
          <span>Email Accounts</span>
        </a>
        <a href="#api" data-link class="group flex items-center gap-3 rounded-xl px-4 py-3 text-sm font-medium text-white/70 hover:text-white hover:bg-white/10 transition">
          <i class="fas fa-key text-white/50 group-hover:text-white"></i>
          <span>API Keys</span>
        </a>
      </nav>

      <div class="mt-8 rounded-xl border border-rose-500/30 bg-rose-500/10 p-4">
        <h4 class="text-sm font-semibold text-rose-200">Danger Zone</h4>
        <p class="mt-1 text-xs text-rose-200/80">These actions are irreversible. Proceed carefully.</p>
        <button type="button" id="delete-account" class="mt-4 inline-flex items-center gap-2 rounded-lg bg-gradient-to-r from-rose-600 to-rose-500 px-4 py-2 text-sm font-semibold text-white shadow-lg shadow-rose-900/30 hover:translate-y-[-1px] transition">
          <i class="fas fa-trash"></i>
          Delete Account
        </button>
      </div>
    </aside>

    <!-- Content -->
    <main class="rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl p-8">
      <!-- Profile -->
      <section id="profile" data-section class="space-y-6">
        <header>
          <h2 class="text-xl font-bold text-white/90">Profile Information</h2>
          <p class="text-sm text-white/60">Update your personal details and preferences.</p>
        </header>
        <form method="post" class="space-y-6">
          {% csrf_token %}
          <div class="grid gap-4 md:grid-cols-2">
            <div>
              <label for="first_name" class="mb-1 block text-sm font-medium text-white/80">First Name</label>
              <input id="first_name" name="first_name" type="text" value="{{ user.first_name }}" placeholder="Enter your first name" class="w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm text-white placeholder-white/40 outline-none ring-0 focus:border-violet-500/60 focus:shadow-[0_0_0_3px] focus:shadow-violet-500/20" />
            </div>
            <div>
              <label for="last_name" class="mb-1 block text-sm font-medium text-white/80">Last Name</label>
              <input id="last_name" name="last_name" type="text" value="{{ user.last_name }}" placeholder="Enter your last name" class="w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm text-white placeholder-white/40 outline-none focus:border-violet-500/60 focus:shadow-[0_0_0_3px] focus:shadow-violet-500/20" />
            </div>
          </div>
          <div>
            <label for="email" class="mb-1 block text-sm font-medium text-white/80">Email Address</label>
            <input id="email" name="email" type="email" value="{{ user.email }}" placeholder="Enter your email" class="w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm text-white placeholder-white/40 outline-none focus:border-violet-500/60 focus:shadow-[0_0_0_3px] focus:shadow-violet-500/20" />
          </div>
          <div>
            <label for="company" class="mb-1 block text-sm font-medium text-white/80">Company Name</label>
            <input id="company" name="company" type="text" value="{{ user.profile.company|default:'' }}" placeholder="Enter your company name" class="w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm text-white placeholder-white/40 outline-none focus:border-violet-500/60 focus:shadow-[0_0_0_3px] focus:shadow-violet-500/20" />
          </div>
          <div>
            <label for="phone" class="mb-1 block text-sm font-medium text-white/80">Phone Number</label>
            <input id="phone" name="phone" type="tel" value="{{ user.profile.phone|default:'' }}" placeholder="Enter your phone number" class="w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm text-white placeholder-white/40 outline-none focus:border-violet-500/60 focus:shadow-[0_0_0_3px] focus:shadow-violet-500/20" />
          </div>
          <button type="submit" class="inline-flex items-center gap-2 rounded-lg bg-gradient-to-r from-violet-600 to-fuchsia-500 px-5 py-2.5 text-sm font-semibold text-white shadow-lg shadow-violet-900/30 hover:translate-y-[-1px] transition">
            <i class="fas fa-save"></i>
            Save Changes
          </button>
        </form>
      </section>

      <!-- Security -->
      <section id="security" data-section class="hidden space-y-6">
        <header>
          <h2 class="text-xl font-bold text-white/90">Security Settings</h2>
          <p class="text-sm text-white/60">Manage your password and two‑factor authentication.</p>
        </header>
        <form method="post" class="space-y-6">
          {% csrf_token %}
          <div>
            <label for="current_password" class="mb-1 block text-sm font-medium text-white/80">Current Password</label>
            <input id="current_password" name="current_password" type="password" placeholder="Enter your current password" class="w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm text-white placeholder-white/40 outline-none focus:border-violet-500/60 focus:shadow-[0_0_0_3px] focus:shadow-violet-500/20" />
          </div>
          <div class="grid gap-4 md:grid-cols-2">
            <div>
              <label for="new_password" class="mb-1 block text-sm font-medium text-white/80">New Password</label>
              <input id="new_password" name="new_password" type="password" placeholder="Enter new password" class="w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm text-white placeholder-white/40 outline-none focus:border-violet-500/60 focus:shadow-[0_0_0_3px] focus:shadow-violet-500/20" />
            </div>
            <div>
              <label for="confirm_password" class="mb-1 block text-sm font-medium text-white/80">Confirm Password</label>
              <input id="confirm_password" name="confirm_password" type="password" placeholder="Confirm new password" class="w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm text-white placeholder-white/40 outline-none focus:border-violet-500/60 focus:shadow-[0_0_0_3px] focus:shadow-violet-500/20" />
            </div>
          </div>
          <label class="inline-flex items-center gap-3">
            <input id="two_factor" name="two_factor" type="checkbox" class="h-4 w-4 rounded border-white/20 bg-transparent text-violet-500 focus:ring-violet-400/40" />
            <span class="text-sm text-white/80">Enable Two‑Factor Authentication</span>
          </label>
          <button type="submit" class="inline-flex items-center gap-2 rounded-lg bg-gradient-to-r from-violet-600 to-fuchsia-500 px-5 py-2.5 text-sm font-semibold text-white shadow-lg shadow-violet-900/30 hover:translate-y-[-1px] transition">
            <i class="fas fa-shield-alt"></i>
            Update Security
          </button>
        </form>
      </section>

      <!-- Notifications -->
      <section id="notifications" data-section class="hidden space-y-6">
        <header>
          <h2 class="text-xl font-bold text-white/90">Notification Preferences</h2>
          <p class="text-sm text-white/60">Choose how you want to be notified.</p>
        </header>
        <form method="post" class="space-y-4">
          {% csrf_token %}
          <label class="flex items-center gap-3">
            <input id="email_notifications" name="email_notifications" type="checkbox" checked class="h-4 w-4 rounded border-white/20 bg-transparent text-violet-500 focus:ring-violet-400/40" />
            <span class="text-sm text-white/80">Email Notifications</span>
          </label>
          <label class="flex items-center gap-3">
            <input id="lead_notifications" name="lead_notifications" type="checkbox" checked class="h-4 w-4 rounded border-white/20 bg-transparent text-violet-500 focus:ring-violet-400/40" />
            <span class="text-sm text-white/80">New Lead Alerts</span>
          </label>
          <label class="flex items-center gap-3">
            <input id="property_notifications" name="property_notifications" type="checkbox" class="h-4 w-4 rounded border-white/20 bg-transparent text-violet-500 focus:ring-violet-400/40" />
            <span class="text-sm text-white/80">Property Updates</span>
          </label>
          <label class="flex items-center gap-3">
            <input id="marketing_notifications" name="marketing_notifications" type="checkbox" class="h-4 w-4 rounded border-white/20 bg-transparent text-violet-500 focus:ring-violet-400/40" />
            <span class="text-sm text-white/80">Marketing Emails</span>
          </label>
          <button type="submit" class="mt-2 inline-flex items-center gap-2 rounded-lg bg-gradient-to-r from-violet-600 to-fuchsia-500 px-5 py-2.5 text-sm font-semibold text-white shadow-lg shadow-violet-900/30 hover:translate-y-[-1px] transition">
            <i class="fas fa-bell"></i>
            Save Preferences
          </button>
        </form>
      </section>

      <!-- Billing (placeholder to keep anchors sane) -->
      <section id="billing" data-section class="hidden space-y-6">
        <header>
          <h2 class="text-xl font-bold text-white/90">Billing</h2>
          <p class="text-sm text-white/60">Manage your plan and invoices. (Hook up to your billing provider.)</p>
        </header>
        <div class="rounded-xl border border-white/10 bg-white/5 p-6 text-sm text-white/70">
          Coming soon.
        </div>
      </section>

      <!-- Email Accounts -->
      <section id="email" data-section class="hidden space-y-6">
        <header>
          <h2 class="text-xl font-bold text-white/90">Email Accounts</h2>
          <p class="text-sm text-white/60">Connect Gmail accounts for sending email campaigns.</p>
        </header>
        
        <div class="space-y-6">
          <!-- Connect Gmail Button -->
          <div class="rounded-xl border border-white/10 bg-white/5 p-6">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="text-lg font-semibold text-white/90">Connect Gmail</h3>
                <p class="text-sm text-white/60">Connect your Gmail account to send email campaigns on behalf of your organization.</p>
              </div>
              <a href="{% url 'connect_gmail' %}" class="inline-flex items-center gap-2 rounded-lg bg-gradient-to-r from-violet-600 to-violet-500 px-4 py-2 text-sm font-semibold text-white shadow-lg shadow-violet-900/30 hover:translate-y-[-1px] transition">
                <i class="fas fa-plus"></i>
                Connect Gmail
              </a>
            </div>
          </div>
          
          <!-- Connected Email Accounts -->
          <div class="space-y-4">
            <h3 class="text-lg font-semibold text-white/90">Connected Accounts</h3>
            
            {% if email_accounts %}
              {% for account in email_accounts %}
              <div class="rounded-xl border border-white/10 bg-white/5 p-4">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div class="flex h-10 w-10 items-center justify-center rounded-full bg-violet-500/20">
                      <i class="fas fa-envelope text-violet-400"></i>
                    </div>
                    <div>
                      <div class="flex items-center gap-2">
                        <span class="font-medium text-white/90">{{ account.display_name }}</span>
                        {% if account.is_primary %}
                        <span class="rounded-full bg-emerald-500/20 px-2 py-1 text-xs font-medium text-emerald-400">Primary</span>
                        {% endif %}
                        {% if account.is_verified %}
                        <span class="rounded-full bg-emerald-500/20 px-2 py-1 text-xs font-medium text-emerald-400">Verified</span>
                        {% endif %}
                      </div>
                      <p class="text-sm text-white/60">{{ account.email_address }}</p>
                      <p class="text-xs text-white/50">
                        Connected {{ account.created_at|timesince }} ago
                        {% if account.last_used_at %}
                        • Last used {{ account.last_used_at|timesince }} ago
                        {% endif %}
                      </p>
                    </div>
                  </div>
                  
                  <div class="flex items-center gap-2">
                    {% if not account.is_primary %}
                    <a href="{% url 'set_primary_email' account.id %}" class="rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm font-medium text-white/80 hover:bg-white/10 transition">
                      Set Primary
                    </a>
                    {% endif %}
                    <a href="{% url 'disconnect_gmail' account.id %}" class="rounded-lg border border-rose-500/30 bg-rose-500/10 px-3 py-2 text-sm font-medium text-rose-400 hover:bg-rose-500/20 transition">
                      Disconnect
                    </a>
                  </div>
                </div>
              </div>
              {% endfor %}
            {% else %}
              <div class="rounded-xl border border-white/10 bg-white/5 p-6 text-center">
                <div class="mx-auto mb-4 flex h-12 w-12 items-center justify-center rounded-full bg-white/5">
                  <i class="fas fa-envelope text-white/40"></i>
                </div>
                <h3 class="text-lg font-semibold text-white/70">No Email Accounts Connected</h3>
                <p class="text-sm text-white/50">Connect a Gmail account to start sending email campaigns.</p>
              </div>
            {% endif %}
          </div>
        </div>
      </section>

      <!-- API Keys -->
      <section id="api" data-section class="hidden space-y-6">
        <header>
          <h2 class="text-xl font-bold text-white/90">API Keys</h2>
          <p class="text-sm text-white/60">Securely manage credentials for integrations.</p>
        </header>
        <div class="space-y-6">
          <div>
            <label for="api_key" class="mb-1 block text-sm font-medium text-white/80">Your API Key</label>
            <div class="flex items-center gap-3">
              <input id="api_key" type="text" readonly value="katek_sk_1234567890abcdef" class="w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm text-white/80 outline-none" />
              <button type="button" id="copy-key" class="inline-flex items-center gap-2 rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm font-medium text-white/80 hover:bg-white/10 transition">
                <i class="fas fa-copy"></i>
                Copy
              </button>
            </div>
          </div>
          <div>
            <label for="webhook_url" class="mb-1 block text-sm font-medium text-white/80">Webhook URL</label>
            <input id="webhook_url" type="url" readonly value="https://api.katek.ai/webhooks/your-webhook" class="w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm text-white/80 outline-none" />
          </div>
          <button type="button" id="regen-key" class="inline-flex items-center gap-2 rounded-lg bg-gradient-to-r from-violet-600 to-fuchsia-500 px-5 py-2.5 text-sm font-semibold text-white shadow-lg shadow-violet-900/30 hover:translate-y-[-1px] transition">
            <i class="fas fa-sync"></i>
            Regenerate Keys
          </button>
        </div>
      </section>
    </main>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
  // Simple hash-based section router
  const links = document.querySelectorAll('[data-link]');
  const sections = document.querySelectorAll('[data-section]');

  function activate(targetId) {
    sections.forEach(s => s.classList.toggle('hidden', s.id !== targetId));
    links.forEach(l => {
      const active = l.getAttribute('href') === '#' + targetId;
      l.classList.toggle('bg-white/10', active);
      l.classList.toggle('text-white', active);
      l.classList.toggle('text-white/70', !active);
    });
  }

  function initFromHash() {
    const id = (location.hash || '#profile').replace('#','');
    const exists = document.getElementById(id);
    activate(exists ? id : 'profile');
  }

  window.addEventListener('hashchange', initFromHash);
  initFromHash();

  // Clipboard copy using modern API
  const copyBtn = document.getElementById('copy-key');
  if (copyBtn) {
    copyBtn.addEventListener('click', async () => {
      const val = document.getElementById('api_key').value;
      try {
        await navigator.clipboard.writeText(val);
        copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied';
        copyBtn.classList.add('bg-emerald-600/80');
        setTimeout(() => {
          copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy';
          copyBtn.classList.remove('bg-emerald-600/80');
        }, 1800);
      } catch (e) {
        alert('Copy failed. Please copy manually.');
      }
    });
  }

  // Regenerate keys (wire to backend later)
  const regen = document.getElementById('regen-key');
  if (regen) {
    regen.addEventListener('click', async () => {
      // TODO: POST to your endpoint then update #api_key value
      console.log('Regenerate requested');
      regen.disabled = true;
      regen.classList.add('opacity-70');
      setTimeout(() => { // demo only
        document.getElementById('api_key').value = 'katek_sk_' + Math.random().toString(36).slice(2, 10) + Date.now().toString().slice(-4);
        regen.disabled = false;
        regen.classList.remove('opacity-70');
      }, 800);
    });
  }

  // Delete account confirmations
  const del = document.getElementById('delete-account');
  if (del) {
    del.addEventListener('click', () => {
      const sure = confirm('Are you sure you want to delete your account? This action cannot be undone.');
      if (!sure) return;
      const again = prompt('Type DELETE to confirm.');
      if (again === 'DELETE') {
        // TODO: Call your deletion endpoint
        alert('Account deletion would be processed here.');
      }
    });
  }

  // Basic form required validation feedback (client-side only)
  document.querySelectorAll('form').forEach(form => {
    form.addEventListener('submit', (e) => {
      const required = form.querySelectorAll('[required]');
      let ok = true;
      required.forEach(f => {
        if (!f.value.trim()) {
          f.classList.add('border-rose-500/70', 'shadow-[0_0_0_3px]', 'shadow-rose-500/20');
          ok = false;
        } else {
          f.classList.remove('border-rose-500/70', 'shadow-[0_0_0_3px]', 'shadow-rose-500/20');
        }
      });
      if (!ok) {
        e.preventDefault();
        alert('Please fill in all required fields.');
      }
    });
  });
})();
</script>
{% endblock %}