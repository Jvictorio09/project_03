{% extends 'base_internal.html' %}
{% load static %}
{% load humanize %}

{% block title %}Dashboard - KaTek AI{% endblock %}

{% block page_title %}Dashboard{% endblock %}

{% block content %}
<div class="space-y-8">
  <!-- Header -->
  <div>
    <h1 class="text-3xl font-bold text-white mb-2">Welcome back, {{ user.first_name|default:user.username }}!</h1>
    <p class="text-gray-300 text-lg">Here's what's happening with your AI agent today</p>
  </div>
  
  <!-- Metrics Grid -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
    <div class="bg-white/5 backdrop-blur-md border border-white/10 rounded-xl p-6 text-center hover:bg-white/10 hover:border-white/20 transition-all duration-200 cursor-pointer group">
      <div class="w-12 h-12 bg-gradient-to-br from-violet-600 to-violet-500 rounded-lg flex items-center justify-center mx-auto mb-4 group-hover:scale-105 transition-transform duration-200">
        <i class="fas fa-users text-white text-lg"></i>
      </div>
      <div class="text-3xl font-bold text-violet-400 mb-1">{{ leads_today|default:0 }}</div>
      <div class="text-gray-300 text-sm font-medium mb-1">Leads Today</div>
      {% if leads_delta %}
        <div class="{% if leads_delta > 0 %}text-emerald-400{% else %}text-red-400{% endif %} text-xs font-medium">
          {% if leads_delta > 0 %}+{% endif %}{{ leads_delta|floatformat:0 }}% from yesterday
        </div>
      {% else %}
        <div class="text-gray-500 text-xs font-medium">No data</div>
      {% endif %}
    </div>
    
    <div class="bg-white/5 backdrop-blur-md border border-white/10 rounded-xl p-6 text-center hover:bg-white/10 hover:border-white/20 transition-all duration-200 cursor-pointer group">
      <div class="w-12 h-12 bg-gradient-to-br from-violet-600 to-violet-500 rounded-lg flex items-center justify-center mx-auto mb-4 group-hover:scale-105 transition-transform duration-200">
        <i class="fas fa-comments text-white text-lg"></i>
      </div>
      <div class="text-3xl font-bold text-violet-400 mb-1">{{ active_conversations|default:0 }}</div>
      <div class="text-gray-300 text-sm font-medium mb-1">Active Conversations</div>
      <div class="text-gray-500 text-xs font-medium">Last 60 minutes</div>
    </div>
    
    <div class="bg-white/5 backdrop-blur-md border border-white/10 rounded-xl p-6 text-center hover:bg-white/10 hover:border-white/20 transition-all duration-200 cursor-pointer group">
      <div class="w-12 h-12 bg-gradient-to-br from-violet-600 to-violet-500 rounded-lg flex items-center justify-center mx-auto mb-4 group-hover:scale-105 transition-transform duration-200">
        <i class="fas fa-home text-white text-lg"></i>
      </div>
      <div class="text-3xl font-bold text-violet-400 mb-1">
        {% if inventory_value >= 1000000 %}
          {% widthratio inventory_value 1000000 1 as millions %}
          ${{ millions }}M
        {% elif inventory_value >= 1000 %}
          {% widthratio inventory_value 1000 1 as thousands %}
          ${{ thousands }}K
        {% else %}
          ${{ inventory_value|floatformat:0|intcomma|default:"0" }}
        {% endif %}
      </div>
      <div class="text-gray-300 text-sm font-medium mb-1">Inventory Value</div>
      <div class="text-gray-500 text-xs font-medium">Active properties</div>
    </div>
    
    <div class="bg-white/5 backdrop-blur-md border border-white/10 rounded-xl p-6 text-center hover:bg-white/10 hover:border-white/20 transition-all duration-200 cursor-pointer group">
      <div class="w-12 h-12 bg-gradient-to-br from-violet-600 to-violet-500 rounded-lg flex items-center justify-center mx-auto mb-4 group-hover:scale-105 transition-transform duration-200">
        <i class="fas fa-chart-line text-white text-lg"></i>
      </div>
      <div class="text-3xl font-bold text-violet-400 mb-1">{{ conversion_rate|floatformat:0|default:0 }}%</div>
      <div class="text-gray-300 text-sm font-medium mb-1">Conversion Rate</div>
      <div class="text-gray-500 text-xs font-medium">Last 30 days</div>
    </div>
  </div>
  
  <!-- Main Content Grid -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Chart Section -->
    <div class="lg:col-span-2">
      <div class="bg-white/5 backdrop-blur-md border border-white/10 rounded-xl p-6 shadow-xl">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-bold text-white">Leads Over Time</h3>
          <div class="flex gap-2">
            <a href="?range=7" class="px-3 py-1 {% if request.GET.range == '7' or not request.GET.range %}bg-violet-600 text-white{% else %}bg-white/10 border border-white/20 text-gray-300{% endif %} text-xs rounded-lg font-medium hover:bg-white/20 transition-all duration-200">7 Days</a>
            <a href="?range=30" class="px-3 py-1 {% if request.GET.range == '30' %}bg-violet-600 text-white{% else %}bg-white/10 border border-white/20 text-gray-300{% endif %} text-xs rounded-lg font-medium hover:bg-white/20 transition-all duration-200">30 Days</a>
            <a href="?range=90" class="px-3 py-1 {% if request.GET.range == '90' %}bg-violet-600 text-white{% else %}bg-white/10 border border-white/20 text-gray-300{% endif %} text-xs rounded-lg font-medium hover:bg-white/20 transition-all duration-200">90 Days</a>
          </div>
        </div>
        {% if timeseries_data %}
          <div class="h-80 bg-gradient-to-br from-white/5 to-white/10 rounded-lg p-4">
            <canvas id="leadsChart"></canvas>
          </div>
          <script>
            document.addEventListener('DOMContentLoaded', function() {
              const ctx = document.getElementById('leadsChart');
              if (ctx) {
                const chartData = {{ timeseries_json|safe }};
                
                new Chart(ctx, {
                  type: 'line',
                  data: {
                    labels: chartData.map(item => item.date),
                    datasets: [{
                      label: 'Leads Created',
                      data: chartData.map(item => item.count),
                      borderColor: '#6366f1',
                      backgroundColor: 'rgba(99, 102, 241, 0.1)',
                      fill: true,
                      tension: 0.4
                    }]
                  },
                  options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                      legend: {
                        display: false
                      }
                    },
                    scales: {
                      y: {
                        beginAtZero: true,
                        ticks: {
                          color: '#9ca3af'
                        },
                        grid: {
                          color: 'rgba(255, 255, 255, 0.1)'
                        }
                      },
                      x: {
                        ticks: {
                          color: '#9ca3af'
                        },
                        grid: {
                          color: 'rgba(255, 255, 255, 0.1)'
                        }
                      }
                    }
                  }
                });
              }
            });
          </script>
        {% else %}
          <div class="h-80 bg-gradient-to-br from-white/5 to-white/10 rounded-lg flex items-center justify-center">
            <div class="text-center text-gray-400">
              <i class="fas fa-chart-area text-4xl mb-4"></i>
              <p class="text-lg">No data available</p>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
    
    <!-- Sidebar -->
    <div class="space-y-6">
      <!-- Recent Conversations -->
      <div class="bg-white/5 backdrop-blur-md border border-white/10 rounded-xl p-6 shadow-xl">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold text-white">Recent Conversations</h3>
          <a href="#" class="text-violet-400 text-sm font-medium hover:text-violet-300 transition-colors duration-200">View All</a>
        </div>
        
        <div class="space-y-3">
          {% if recent_conversations %}
            {% for conv in recent_conversations %}
              <div class="flex items-center gap-3 p-3 rounded-lg hover:bg-white/10 transition-all duration-200 cursor-pointer">
                <div class="w-10 h-10 bg-violet-600 rounded-full flex items-center justify-center text-white font-bold text-sm">{{ conv.name|first|upper }}</div>
                <div class="flex-1 min-w-0">
                  <p class="text-white text-sm font-medium">{{ conv.name }}</p>
                  <p class="text-gray-400 text-xs truncate">{{ conv.last_message_snippet }}</p>
                </div>
                <div class="text-gray-400 text-xs">
                  {% if conv.minutes_ago < 60 %}
                    {{ conv.minutes_ago }}m ago
                  {% else %}
                    {% widthratio conv.minutes_ago 60 1 %}h ago
                  {% endif %}
                  <span class="ml-2 text-violet-400 text-xs">{{ conv.channel }}</span>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <div class="text-center text-gray-400 py-8">
              <i class="fas fa-comments text-2xl mb-2"></i>
              <p class="text-sm">No recent conversations</p>
            </div>
          {% endif %}
        </div>
      </div>
      
      <!-- Quick Actions -->
      <div class="bg-white/5 backdrop-blur-md border border-white/10 rounded-xl p-6 shadow-xl">
        <h3 class="text-lg font-bold text-white mb-4">Quick Actions</h3>
        <div class="space-y-3">
          {% load extras %}
          {% is_feature_enabled 'property_creation' as property_creation_enabled %}
          {% if property_creation_enabled %}
            <a href="#" class="flex items-center gap-3 p-4 bg-white/5 border border-white/10 rounded-lg hover:bg-white/10 hover:border-white/20 transition-all duration-200 cursor-pointer group" hx-get="{% url 'add_property_modal' %}" hx-target="#add-property-modal .modal-body" hx-swap="innerHTML" hx-trigger="click" onclick="event.preventDefault(); setTimeout(() => document.getElementById('add-property-modal').classList.remove('hidden'), 100);">
              <div class="w-10 h-10 bg-violet-600 rounded-lg flex items-center justify-center group-hover:scale-105 transition-transform duration-200">
                <i class="fas fa-plus text-white"></i>
              </div>
              <div>
                <h4 class="text-white text-sm font-bold">Add Property</h4>
                <p class="text-gray-400 text-xs">Upload new listing</p>
              </div>
            </a>
          {% else %}
            {% get_disabled_tooltip 'property_creation' as property_creation_tooltip %}
            <a href="#" class="flex items-center gap-3 p-4 bg-white/5 border border-white/10 rounded-lg opacity-50 cursor-not-allowed" disabled title="{{ property_creation_tooltip }}">
              <div class="w-10 h-10 bg-gray-600 rounded-lg flex items-center justify-center">
                <i class="fas fa-plus text-white"></i>
              </div>
              <div>
                <h4 class="text-gray-400 text-sm font-bold">Add Property</h4>
                <p class="text-gray-500 text-xs">Upload new listing</p>
              </div>
            </a>
          {% endif %}
          
          {% is_feature_enabled 'campaign_management' as campaign_management_enabled %}
          {% if campaign_management_enabled %}
            <a href="#" class="flex items-center gap-3 p-4 bg-white/5 border border-white/10 rounded-lg hover:bg-white/10 hover:border-white/20 transition-all duration-200 cursor-pointer group">
              <div class="w-10 h-10 bg-violet-600 rounded-lg flex items-center justify-center group-hover:scale-105 transition-transform duration-200">
                <i class="fas fa-paper-plane text-white"></i>
              </div>
              <div>
                <h4 class="text-white text-sm font-bold">Send Campaign</h4>
                <p class="text-gray-400 text-xs">Email your leads</p>
              </div>
            </a>
          {% else %}
            {% get_disabled_tooltip 'campaign_management' as campaign_management_tooltip %}
            <a href="#" class="flex items-center gap-3 p-4 bg-white/5 border border-white/10 rounded-lg opacity-50 cursor-not-allowed" disabled title="{{ campaign_management_tooltip }}">
              <div class="w-10 h-10 bg-gray-600 rounded-lg flex items-center justify-center">
                <i class="fas fa-paper-plane text-white"></i>
              </div>
              <div>
                <h4 class="text-gray-400 text-sm font-bold">Send Campaign</h4>
                <p class="text-gray-500 text-xs">Email your leads</p>
              </div>
            </a>
          {% endif %}
          
          <a href="{% url 'chat_agent' %}" class="flex items-center gap-3 p-4 bg-white/5 border border-white/10 rounded-lg hover:bg-white/10 hover:border-white/20 transition-all duration-200 cursor-pointer group">
            <div class="w-10 h-10 bg-violet-600 rounded-lg flex items-center justify-center group-hover:scale-105 transition-transform duration-200">
              <i class="fas fa-robot text-white"></i>
            </div>
            <div>
              <h4 class="text-white text-sm font-bold">Configure AI</h4>
              <p class="text-gray-400 text-xs">Setup your agent</p>
            </div>
          </a>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Recent Properties -->
  <div>
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-white">Recent Properties</h2>
      <a href="{% url 'properties' %}" class="px-4 py-2 bg-white/10 border border-white/20 text-gray-300 rounded-lg hover:bg-white/20 hover:text-white transition-all duration-200 font-medium">View All Properties</a>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {% if recent_properties %}
        {% for property in recent_properties %}
          <a href="{% url 'property_detail' property.slug %}" class="bg-white/5 backdrop-blur-md border border-white/10 rounded-xl overflow-hidden hover:bg-white/10 hover:border-white/20 transition-all duration-200 cursor-pointer group">
            <div class="h-48 bg-gradient-to-br from-white/5 to-white/10 flex items-center justify-center">
              {% if property.hero_image %}
                <img src="{{ property.hero_image }}" alt="{{ property.title }}" class="w-full h-full object-cover">
              {% else %}
                <i class="fas fa-home text-gray-400 text-4xl"></i>
              {% endif %}
            </div>
            <div class="p-4">
              <h3 class="text-lg font-bold text-white mb-2">{{ property.title }}</h3>
              <p class="text-gray-400 text-sm mb-2">{{ property.city }}{% if property.area %}, {{ property.area }}{% endif %}</p>
              <p class="text-violet-400 text-xl font-bold mb-3">${{ property.price_amount|floatformat:0|intcomma }}</p>
              <div class="flex gap-4 text-gray-400 text-xs">
                <span><i class="fas fa-bed mr-1"></i>{{ property.beds }} bed{{ property.beds|pluralize }}</span>
                <span><i class="fas fa-bath mr-1"></i>{{ property.baths }} bath{{ property.baths|pluralize }}</span>
                {% if property.floor_area_sqm %}
                  <span><i class="fas fa-ruler mr-1"></i>{{ property.floor_area_sqm }} sqm</span>
                {% endif %}
              </div>
            </div>
          </a>
        {% endfor %}
      {% else %}
        <div class="col-span-3 text-center text-gray-400 py-12">
          <i class="fas fa-home text-4xl mb-4"></i>
          <p class="text-lg">No properties yet</p>
          <p class="text-sm mt-2">Add your first property to get started</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="{% static 'js/modal.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Chart rendering
  {% if timeseries_data %}
    const ctx = document.getElementById('leadsChart');
    if (ctx) {
      const chartData = [
        {% for item in timeseries_data %}
          {date: "{{ item.date }}", count: {{ item.count }}}{% if not forloop.last %},{% endif %}
        {% endfor %}
      ];
      
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: chartData.map(item => item.date),
          datasets: [{
            label: 'Leads Created',
            data: chartData.map(item => item.count),
            borderColor: '#6366f1',
            backgroundColor: 'rgba(99, 102, 241, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: '#9ca3af'
              },
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              }
            },
            x: {
              ticks: {
                color: '#9ca3af'
              },
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              }
            }
          }
        }
      });
    }
  {% endif %}
  
  // Chart filter interactions
  const filterBtns = document.querySelectorAll('.filter-btn');
  filterBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      filterBtns.forEach(b => {
        b.classList.remove('bg-violet-600', 'text-white');
        b.classList.add('bg-white/10', 'border', 'border-white/20', 'text-gray-300');
      });
      this.classList.remove('bg-white/10', 'border', 'border-white/20', 'text-gray-300');
      this.classList.add('bg-violet-600', 'text-white');
    });
  });
  
  // Metric tile interactions
  const metricTiles = document.querySelectorAll('.metric-tile');
  metricTiles.forEach(tile => {
    tile.addEventListener('click', function() {
      // Add click animation
      this.style.transform = 'scale(0.98)';
      setTimeout(() => {
        this.style.transform = '';
      }, 150);
    });
  });
});
</script>

<!-- Add Property Modal -->
<div id="add-property-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="add-property-modalLabel" aria-hidden="true">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <!-- Background overlay -->
        <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity" onclick="document.getElementById('add-property-modal').classList.add('hidden');"></div>
        
        <!-- Modal panel -->
        <div class="inline-block align-bottom bg-slate-800 rounded-xl border border-white/10 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
            <div class="bg-slate-800 px-6 pt-6 pb-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-white" id="add-property-modalLabel">Add New Property</h3>
                    <button type="button" class="text-gray-400 hover:text-white transition-colors" onclick="document.getElementById('add-property-modal').classList.add('hidden');">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Content will be loaded here via HTMX -->
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}