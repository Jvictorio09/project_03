{% extends "base.html" %}
{% load static %}{% load extras %}{% load humanize %}

{% block title %}Search Results - PropertyHub{% endblock %}

{% block content %}

<!-- Top Notice Bar (shows only when filters are active) -->
{% if request.GET.q or request.GET.city or request.GET.beds or request.GET.price_max or request.GET.buy_or_rent or request.GET.ai_prompt %}
<div class="bg-white border-b border-gray-200 sticky top-0 z-20">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div class="flex flex-wrap items-center gap-2 text-sm">
        <span class="text-gray-600 mr-1">Filters:</span>

        {% if request.GET.buy_or_rent %}
          <span class="inline-flex items-center gap-1 bg-violet-50 text-violet-800 px-2 py-1 rounded-full">
            Type: {{ request.GET.buy_or_rent|title }}
          </span>
        {% endif %}
        {% if request.GET.price_max %}
          <span class="inline-flex items-center gap-1 bg-violet-50 text-violet-800 px-2 py-1 rounded-full">
            ≤ ${{ request.GET.price_max|intcomma }}
          </span>
        {% endif %}
        {% if request.GET.beds %}
          <span class="inline-flex items-center gap-1 bg-violet-50 text-violet-800 px-2 py-1 rounded-full">
            {{ request.GET.beds }}+ Beds
          </span>
        {% endif %}
        {% if request.GET.city %}
          <span class="inline-flex items-center gap-1 bg-violet-50 text-violet-800 px-2 py-1 rounded-full">
            {{ request.GET.city }}
          </span>
        {% endif %}
        {% if request.GET.q %}
          <span class="inline-flex items-center gap-1 bg-violet-50 text-violet-800 px-2 py-1 rounded-full">
            “{{ request.GET.q }}”
          </span>
        {% endif %}
      </div>

      <div class="flex items-center gap-2">
        <a href="{% url 'results' %}"
           class="inline-flex items-center gap-2 bg-gray-100 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-200 transition text-sm font-medium">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
          Clear all
        </a>
      </div>
    </div>
  </div>
</div>
{% endif %}

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="flex flex-col lg:flex-row gap-8">

    <!-- Sidebar Filters (Desktop) -->
    <aside class="hidden lg:block w-80 flex-shrink-0">
      <div class="bg-white rounded-2xl shadow-lg p-6 sticky top-8">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold">Filters</h3>
          <a href="{% url 'results' %}" class="text-sm text-gray-500 hover:text-gray-700">Reset</a>
        </div>

        <form method="GET" action="{% url 'results' %}" id="filter-form" class="space-y-6">
          <input type="hidden" name="q" value="{{ request.GET.q }}">

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Property Type</label>
            <select name="buy_or_rent" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
              <option value="">Any Type</option>
              <option value="rent" {% if request.GET.buy_or_rent == "rent" %}selected{% endif %}>For Rent</option>
              <option value="buy"  {% if request.GET.buy_or_rent == "buy" %}selected{% endif %}>For Sale</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Max Price</label>
            <select name="price_max" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
              <option value="">Any Price</option>
              <option value="50000"  {% if request.GET.price_max == "50000" %}selected{% endif %}>Under $50,000</option>
              <option value="100000" {% if request.GET.price_max == "100000" %}selected{% endif %}>Under $100,000</option>
              <option value="200000" {% if request.GET.price_max == "200000" %}selected{% endif %}>Under $200,000</option>
              <option value="500000" {% if request.GET.price_max == "500000" %}selected{% endif %}>Under $500,000</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Bedrooms</label>
            <select name="beds" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
              <option value="">Any Beds</option>
              <option value="1" {% if request.GET.beds == "1" %}selected{% endif %}>1+ Bed</option>
              <option value="2" {% if request.GET.beds == "2" %}selected{% endif %}>2+ Beds</option>
              <option value="3" {% if request.GET.beds == "3" %}selected{% endif %}>3+ Beds</option>
              <option value="4" {% if request.GET.beds == "4" %}selected{% endif %}>4+ Beds</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">City</label>
            <select name="city" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
              <option value="">Any City</option>
              <option value="Taguig"       {% if request.GET.city == "Taguig" %}selected{% endif %}>Taguig/BGC</option>
              <option value="Makati"       {% if request.GET.city == "Makati" %}selected{% endif %}>Makati</option>
              <option value="Pasig"        {% if request.GET.city == "Pasig" %}selected{% endif %}>Pasig</option>
              <option value="Quezon City"  {% if request.GET.city == "Quezon City" %}selected{% endif %}>Quezon City</option>
            </select>
          </div>

          <button type="submit"
                  class="w-full bg-violet-600 text-white py-2 px-4 rounded-lg hover:bg-violet-700 transition font-medium">
            Apply Filters
          </button>
        </form>
      </div>
    </aside>

    <!-- Results -->
    <section class="flex-1">
      <!-- Results Header -->
      <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between mb-6 gap-4">
        <div>
          <h1 class="text-2xl font-bold text-gray-900">Search Results</h1>
          <p class="text-gray-600">{{ count }} match{{ count|pluralize }} found</p>
        </div>

        <!-- Right actions -->
        <div class="flex items-center gap-2">
          <form method="GET" action="{% url 'results' %}">
            {# preserve filters while changing sort #}
            <input type="hidden" name="q" value="{{ request.GET.q }}">
            <input type="hidden" name="buy_or_rent" value="{{ request.GET.buy_or_rent }}">
            <input type="hidden" name="price_max" value="{{ request.GET.price_max }}">
            <input type="hidden" name="beds" value="{{ request.GET.beds }}">
            <input type="hidden" name="city" value="{{ request.GET.city }}">
            <select name="sort" class="px-3 py-2 border border-gray-300 rounded-lg text-sm"
                    onchange="this.form.submit()">
              <option value="">Sort</option>
              <option value="price_asc"  {% if request.GET.sort == "price_asc" %}selected{% endif %}>Price: Low to High</option>
              <option value="price_desc" {% if request.GET.sort == "price_desc" %}selected{% endif %}>Price: High to Low</option>
              <option value="newest"     {% if request.GET.sort == "newest" %}selected{% endif %}>Newest</option>
            </select>
          </form>

          <a href="{% url 'results' %}"
             class="hidden sm:inline-flex items-center gap-2 bg-gray-100 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-200 transition text-sm font-medium">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
            </svg>
            View All
          </a>

          <button class="lg:hidden bg-violet-600 text-white px-4 py-2 rounded-lg text-sm font-medium"
                  x-data x-on:click="$dispatch('open-filters')">
            Refine
          </button>
        </div>
      </div>

      <!-- Results Grid -->
      {% if properties %}
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
          {% for property in properties %}
            <div class="bg-white rounded-2xl shadow-lg hover:shadow-xl transition overflow-hidden">
              <a class="block aspect-[16/10] overflow-hidden" href="{% url 'property_detail' property.slug %}">
                <img
                  src="{{ property.hero_image|default:'https://images.unsplash.com/photo-1564013799919-ab600027ffc6?w=1200' }}"
                  alt="{{ property.title }}"
                  class="w-full h-full object-cover transition-transform duration-300 hover:scale-[1.03]">
              </a>
              <div class="p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-1 line-clamp-1">{{ property.title }}</h3>
                {% if property.price_amount %}
                  <p class="text-violet-700 font-bold text-xl mb-2">
                    ${{ property.price_amount|floatformat:0|intcomma }}
                  </p>
                {% endif %}

                <div class="flex flex-wrap items-center gap-x-4 gap-y-1 text-gray-600 text-sm mb-3">
                  {% if property.beds %}<span>{{ property.beds }} bed{{ property.beds|pluralize }}</span>{% endif %}
                  {% if property.baths %}<span>{{ property.baths }} bath{{ property.baths|pluralize }}</span>{% endif %}
                  {% if property.floor_area_sqm %}<span>{{ property.floor_area_sqm }} sqm</span>{% endif %}
                </div>

                <p class="text-gray-600 text-sm mb-4 line-clamp-1">
                  {{ property.city }}{% if property.area %}, {{ property.area }}{% endif %}
                </p>

                {% if property.badges %}
                  <div class="flex flex-wrap gap-2 mb-5">
                    {% for badge in property.badges|split:"," %}
                      {% if badge %}
                        <span class="bg-violet-100 text-violet-800 px-2.5 py-1 rounded-full text-xs">{{ badge|strip }}</span>
                      {% endif %}
                    {% endfor %}
                  </div>
                {% endif %}

                <div class="flex gap-2">
                  <a href="{% url 'property_detail' property.slug %}"
                     class="flex-1 bg-violet-600 text-white text-center py-2 rounded-lg hover:bg-violet-700 transition font-medium">
                    View Details
                  </a>
                  <button type="button"
                          class="px-4 py-2 rounded-lg bg-gray-100 text-gray-800 hover:bg-gray-200 transition font-medium"
                          onclick="addToShortlist('{{ property.id }}')">
                    Ask
                  </button>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <!-- Empty State -->
        <div class="text-center py-20 bg-white rounded-2xl shadow-sm">
          <div class="text-gray-400 text-6xl mb-3">🏠</div>
          <h3 class="text-xl font-semibold text-gray-900 mb-2">No properties found</h3>
          <p class="text-gray-600 mb-6">Try adjusting your filters or clear all to see more results.</p>
          <a href="{% url 'results' %}"
             class="inline-flex items-center gap-2 bg-gray-100 text-gray-800 px-5 py-2.5 rounded-lg hover:bg-gray-200 transition">
            Clear Filters
          </a>
        </div>
      {% endif %}
    </section>
  </div>
</div>

<!-- Mobile Filter Drawer -->
<div x-data="{ open: false }"
     x-on:open-filters.window="open = true"
     x-on:close-filters.window="open = false"
     class="lg:hidden">

  <!-- Backdrop -->
  <div x-show="open"
       x-transition.opacity
       class="fixed inset-0 bg-black/50 z-40"
       x-on:click="open = false"></div>

  <!-- Panel -->
  <div x-show="open"
       x-transition:enter="transition ease-out duration-300"
       x-transition:enter-start="translate-x-full"
       x-transition:enter-end="translate-x-0"
       x-transition:leave="transition ease-in duration-200"
       x-transition:leave-start="translate-x-0"
       x-transition:leave-end="translate-x-full"
       class="fixed right-0 top-0 h-full w-80 bg-white shadow-xl z-50 overflow-y-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-lg font-semibold">Filters</h3>
        <button x-on:click="open = false" class="text-gray-400 hover:text-gray-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <form method="GET" action="{% url 'results' %}" class="space-y-6">
        <input type="hidden" name="q" value="{{ request.GET.q }}">

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Property Type</label>
          <select name="buy_or_rent" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            <option value="">Any Type</option>
            <option value="rent" {% if request.GET.buy_or_rent == "rent" %}selected{% endif %}>For Rent</option>
            <option value="buy"  {% if request.GET.buy_or_rent == "buy" %}selected{% endif %}>For Sale</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Max Price</label>
          <select name="price_max" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            <option value="">Any Price</option>
            <option value="50000"  {% if request.GET.price_max == "50000" %}selected{% endif %}>Under $50,000</option>
            <option value="100000" {% if request.GET.price_max == "100000" %}selected{% endif %}>Under $100,000</option>
            <option value="200000" {% if request.GET.price_max == "200000" %}selected{% endif %}>Under $200,000</option>
            <option value="500000" {% if request.GET.price_max == "500000" %}selected{% endif %}>Under $500,000</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Bedrooms</label>
          <select name="beds" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            <option value="">Any Beds</option>
            <option value="1" {% if request.GET.beds == "1" %}selected{% endif %}>1+ Bed</option>
            <option value="2" {% if request.GET.beds == "2" %}selected{% endif %}>2+ Beds</option>
            <option value="3" {% if request.GET.beds == "3" %}selected{% endif %}>3+ Beds</option>
            <option value="4" {% if request.GET.beds == "4" %}selected{% endif %}>4+ Beds</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">City</label>
          <select name="city" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            <option value="">Any City</option>
            <option value="Taguig"      {% if request.GET.city == "Taguig" %}selected{% endif %}>Taguig/BGC</option>
            <option value="Makati"      {% if request.GET.city == "Makati" %}selected{% endif %}>Makati</option>
            <option value="Pasig"       {% if request.GET.city == "Pasig" %}selected{% endif %}>Pasig</option>
            <option value="Quezon City" {% if request.GET.city == "Quezon City" %}selected{% endif %}>Quezon City</option>
          </select>
        </div>

        <div class="flex gap-2 pt-1">
          <a href="{% url 'results' %}" class="flex-1 bg-gray-100 text-gray-800 py-2 rounded-lg text-center hover:bg-gray-200 transition">Reset</a>
          <button type="submit" class="flex-1 bg-violet-600 text-white py-2 rounded-lg hover:bg-violet-700 transition">Apply</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Sticky Bottom Actions (Mobile) -->
<div class="lg:hidden fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur border-t border-gray-200 p-4 z-30">
  <div class="flex gap-2">
    <button class="flex-1 bg-gray-100 text-gray-800 py-3 rounded-lg font-medium"
            x-on:click="$dispatch('open-filters')">
      Refine
    </button>
    <button class="flex-1 bg-gray-100 text-gray-800 py-3 rounded-lg font-medium">
      Save Search
    </button>
    <a href="{% url 'home' %}" class="flex-1 bg-violet-600 text-white py-3 rounded-lg font-medium text-center">
      New Search
    </a>
  </div>
</div>

<script>
  // Optional: replace with your real shortlist logic
  function addToShortlist(id) {
    window.dispatchEvent(new CustomEvent('toast', { detail: { message: 'Added to shortlist.' }}));
    console.log('Shortlist property:', id);
  }
</script>

{% endblock %}
