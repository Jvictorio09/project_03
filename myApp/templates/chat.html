{# templates/public/chat.html #}
{% extends 'base.html' %}
{% load static %}
{% load tz %}

{% block title %}Chat with {{ agent_name|default:"Ava" }} - KaTek Realty{% endblock %}

{% block extra_css %}{% endblock %}

{% block content %}
<div class="min-h-screen bg-slate-950 text-slate-100 flex flex-col" data-agent="{{ agent_slug|default:'default' }}">
  <!-- Header -->
  <header class="sticky top-0 z-10 bg-slate-900/60 backdrop-blur border-b border-white/10 px-6 py-4 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-full bg-gradient-to-br from-violet-600 to-fuchsia-500 grid place-items-center text-white font-bold text-lg select-none">
        {{ agent_name|default:"Ava"|slice:":1"|upper }}
      </div>
      <div>
        <h3 id="agent-title" class="m-0 text-sm font-semibold text-white">
          {{ agent_name|default:"Ava" }} from {{ company_name|default:"KaTek Realty" }}
        </h3>
        <p class="m-0 text-xs text-slate-400">Your AI real estate assistant</p>
      </div>
    </div>
    <div class="flex items-center gap-2 text-emerald-400 text-xs" aria-live="polite">
      <span class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span>
      <span>Online now</span>
    </div>
  </header>

  <!-- Messages -->
  <main id="chat-messages" class="flex-1 px-6 py-6 overflow-y-auto max-w-3xl w-full mx-auto space-y-4" aria-live="polite" aria-relevant="additions text">
    <!-- Initial AI message -->
    <div class="flex items-start gap-3">
      <div class="w-9 h-9 rounded-full bg-slate-800 grid place-items-center text-slate-200 text-sm font-semibold select-none">
        {{ agent_name|default:"Ava"|slice:":1"|upper }}
      </div>
      <div class="bg-slate-900/60 border border-white/10 rounded-2xl px-4 py-3 backdrop-blur">
        <p class="text-sm leading-relaxed">{{ greeting|default:"Hi! I'm Ava from KaTek Realty. How can I help you find your perfect home today?" }}</p>
        <p class="text-[10px] text-slate-400 mt-1">{% now "g:i A" %}</p>
        <!-- Smart chips -->
        <div class="flex flex-wrap gap-2 mt-3" aria-label="Suggested prompts">
          {% if chips %}
            {% for chip in chips %}
              <button data-chip class="px-3 py-1 rounded-full bg-slate-800 border border-white/10 text-xs hover:bg-violet-600 hover:text-white transition">{{ chip }}</button>
            {% endfor %}
          {% else %}
            <button data-chip class="px-3 py-1 rounded-full bg-slate-800 border border-white/10 text-xs hover:bg-violet-600 hover:text-white transition">Homes under $500k</button>
            <button data-chip class="px-3 py-1 rounded-full bg-slate-800 border border-white/10 text-xs hover:bg-violet-600 hover:text-white transition">3 bedroom condos</button>
            <button data-chip class="px-3 py-1 rounded-full bg-slate-800 border border-white/10 text-xs hover:bg-violet-600 hover:text-white transition">Near good schools</button>
            <button data-chip class="px-3 py-1 rounded-full bg-slate-800 border border-white/10 text-xs hover:bg-violet-600 hover:text-white transition">Investment properties</button>
            <button data-chip class="px-3 py-1 rounded-full bg-slate-800 border border-white/10 text-xs hover:bg-violet-600 hover:text-white transition">Book a tour</button>
          {% endif %}
        </div>
      </div>
    </div>
  </main>

  <!-- Input -->
  <div class="bg-slate-900/60 backdrop-blur border-t border-white/10 px-6 py-4">
    <div class="max-w-3xl w-full mx-auto flex items-end gap-3">
      <textarea id="chat-input" rows="1" placeholder="Type your message…" aria-label="Your message"
        class="flex-1 bg-slate-900/60 border border-white/10 rounded-2xl px-4 py-3 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-violet-600/40 resize-none min-h-[44px] max-h-[140px]"></textarea>
      <button id="send-button" aria-label="Send message"
        class="w-11 h-11 rounded-xl grid place-items-center bg-violet-600 text-white hover:bg-violet-500 transition disabled:bg-slate-600 disabled:cursor-not-allowed">
        <i class="fas fa-paper-plane text-sm" aria-hidden="true"></i>
      </button>
    </div>
  </div>
</div>

<!-- CSRF token for JS -->
<input type="hidden" id="csrf-token" value="{{ csrf_token }}">
{% endblock %}

{% block extra_js %}
<script>
(()=>{
  const $ = (s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
  const messages = $('#chat-messages');
  const input = $('#chat-input');
  const sendBtn = $('#send-button');
  const csrf = $('#csrf-token')?.value || '';
  const agent = document.querySelector('[data-agent]')?.dataset.agent || 'default';

  // Auto-resize
  const autoResize = el=>{ el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,140)+'px'; };
  input.addEventListener('input', ()=>autoResize(input));
  input.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); }});
  sendBtn.addEventListener('click', send);
  messages.addEventListener('click', (e)=>{ const b=e.target.closest('[data-chip]'); if(b){ input.value=b.textContent.trim(); send(); }});

  function bubble({role,text,html}){
    const row = document.createElement('div');
    row.className = `flex items-start gap-3 ${role==='user' ? 'flex-row-reverse' : ''}`;

    const avatar = document.createElement('div');
    avatar.className = `w-9 h-9 rounded-full grid place-items-center text-sm font-semibold select-none ${role==='user' ? 'bg-violet-600 text-white' : 'bg-slate-800 text-slate-200'}`;
    avatar.textContent = role==='user' ? 'U' : ('{{ agent_name|default:"Ava"|slice:":1"|upper }}');

    const card = document.createElement('div');
    card.className = `rounded-2xl px-4 py-3 border backdrop-blur max-w-[70%] ${role==='user' ? 'bg-violet-600 text-white border-violet-600' : 'bg-slate-900/60 text-slate-100 border-white/10'}`;
    const p=document.createElement('p'); p.className='text-sm leading-relaxed';

    if(html){ card.insertAdjacentHTML('beforeend', html); }
    else{ p.textContent = text; card.appendChild(p); }

    const t=document.createElement('p'); t.className='text-[10px] mt-1 text-slate-400';
    t.textContent = new Date().toLocaleTimeString([], {hour:'numeric', minute:'2-digit'});
    card.appendChild(t);

    row.appendChild(avatar); row.appendChild(card); messages.appendChild(row);
    messages.scrollTop = messages.scrollHeight;
  }

  let typingEl=null;
  function showTyping(){
    typingEl = document.createElement('div');
    typingEl.className = 'flex items-center gap-2 ml-12 bg-slate-900/60 border border-white/10 rounded-2xl px-3 py-2 w-max';
    typingEl.innerHTML = `
      <div class='flex gap-1'>
        <span class='w-1.5 h-1.5 rounded-full bg-slate-400 animate-[ping_1.4s_infinite]'></span>
        <span class='w-1.5 h-1.5 rounded-full bg-slate-400 animate-[ping_1.4s_infinite_.2s]'></span>
        <span class='w-1.5 h-1.5 rounded-full bg-slate-400 animate-[ping_1.4s_infinite_.4s]'></span>
      </div>
      <span class='text-xs text-slate-400'>{{ agent_name|default:'Ava' }} is typing…</span>`;
    messages.appendChild(typingEl); messages.scrollTop = messages.scrollHeight;
  }
  function hideTyping(){ if(typingEl){ typingEl.remove(); typingEl=null; } }

  async function send(){
    const text = (input.value||'').trim(); if(!text) return;
    sendBtn.disabled=true; bubble({role:'user', text}); input.value=''; autoResize(input); showTyping();
    try{
      const resp = await fetch('/chat/send/', {method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken': csrf}, body: JSON.stringify({agent, message:text})});
      const data = await resp.json(); hideTyping();
      let html = '';
      if(Array.isArray(data.cards)) html += data.cards.join('');
      if(data.reply_html) html += data.reply_html;
      bubble({role:'ai', text: data.reply_text || '', html: html||null});
      if(data.lead_prompt) leadCapture(data.lead_prompt);
    }catch(e){ hideTyping(); bubble({role:'ai', text:"Sorry—I'm having trouble right now. Please try again."}); console.error(e);
    } finally { sendBtn.disabled=false; }
  }

  function leadCapture(headline){
    const row = document.createElement('div');
    row.className = 'flex items-start gap-3';
    row.innerHTML = `
      <div class='w-9 h-9 rounded-full bg-slate-800 grid place-items-center text-slate-200 text-sm font-semibold select-none'>{{ agent_name|default:'A'|slice:':1'|upper }}</div>
      <div class='rounded-2xl px-4 py-3 border backdrop-blur max-w-[70%] bg-gradient-to-br from-violet-600 to-fuchsia-500 text-white border-violet-500/40'>
        <h4 class='text-sm font-semibold m-0 mb-1'>${headline||'Get personalized recommendations'}</h4>
        <p class='text-xs/5 opacity-90 m-0 mb-3'>Share your contact info and we'll send the best matches.</p>
        <form id='lead-form' class='flex flex-wrap items-center gap-2'>
          <label class='sr-only' for='lead-name'>Name</label>
          <input id='lead-name' name='name' required placeholder='Your name'
            class='min-w-[180px] flex-1 px-3 py-2 rounded-md border border-white/30 bg-white/10 placeholder-white/70 text-white text-xs focus:outline-none focus:ring-2 focus:ring-white/30'>
          <label class='sr-only' for='lead-email'>Email</label>
          <input id='lead-email' name='email' type='email' required placeholder='Email address'
            class='min-w-[200px] flex-1 px-3 py-2 rounded-md border border-white/30 bg-white/10 placeholder-white/70 text-white text-xs focus:outline-none focus:ring-2 focus:ring-white/30'>
          <input type='text' name='website' class='hidden' tabindex='-1' autocomplete='off'>
          <label class='flex items-center gap-2 text-xs'>
            <input type='checkbox' name='consent' required class='accent-violet-600'> I agree to be contacted
          </label>
          <button class='px-3 py-2 rounded-md border border-white/30 bg-white/10 text-xs hover:bg-white/20 transition' type='submit'>Get Updates</button>
        </form>
      </div>`;
    messages.appendChild(row); messages.scrollTop = messages.scrollHeight;
    $('#lead-form', row)?.addEventListener('submit', submitLead);
  }

  async function submitLead(e){
    e.preventDefault(); const fd = new FormData(e.target); if(fd.get('website')) return; // honeypot
    try{
      const resp = await fetch('/api/leads/create/', { method:'POST', headers:{'X-CSRFToken': csrf}, body: fd });
      if(!resp.ok) throw new Error('Lead create failed');
      const { name, email } = Object.fromEntries(fd.entries());
      bubble({role:'ai', text:`Thanks ${name}! I'll send recommendations to ${email}.`});
      e.target.closest('.flex.items-start')?.remove();
    }catch(err){ bubble({role:'ai', text:'Sorry, lead capture failed. You can also email us at hello@katek.ai.'}); console.error(err); }
  }
})();
</script>
{% endblock %}


