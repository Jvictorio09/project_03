{% extends 'base_internal.html' %}
{% load static %}

{% block title %}CRM Connection - Setup Wizard{% endblock %}

{% block extra_css %}
<style>
  .setup-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: var(--space-8) var(--space-4);
  }
  
  .setup-header {
    text-align: center;
    margin-bottom: var(--space-12);
  }
  
  .setup-title {
    font-size: 2.5rem;
    font-weight: var(--font-weight-bold);
    margin: 0 0 var(--space-4) 0;
    color: var(--text-primary);
  }
  
  .setup-subtitle {
    font-size: 1.125rem;
    color: var(--text-secondary);
    margin: 0 0 var(--space-6) 0;
  }
  
  .progress-bar {
    width: 100%;
    height: 8px;
    background: var(--surface-glass);
    border-radius: var(--radius-full);
    overflow: hidden;
    margin-bottom: var(--space-8);
  }
  
  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary-purple), var(--electric-violet));
    border-radius: var(--radius-full);
    transition: width 0.6s ease;
    width: {{ progress }}%;
  }
  
  .step-indicator {
    display: flex;
    justify-content: center;
    gap: var(--space-4);
    margin-bottom: var(--space-8);
  }
  
  .step-item {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-4);
    background: var(--surface-glass);
    border-radius: var(--radius-full);
    font-size: 0.875rem;
    font-weight: var(--font-weight-medium);
    transition: all var(--transition-normal);
  }
  
  .step-item.active {
    background: var(--primary-purple);
    color: white;
  }
  
  .step-item.completed {
    background: var(--success-emerald);
    color: white;
  }
  
  .step-number {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: var(--font-weight-bold);
  }
  
  .step-item.active .step-number {
    background: rgba(255, 255, 255, 0.3);
  }
  
  .step-item.completed .step-number {
    background: rgba(255, 255, 255, 0.3);
  }
  
  .crm-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: var(--space-6);
    margin-bottom: var(--space-8);
  }
  
  .crm-option {
    background: var(--surface-glass);
    backdrop-filter: blur(20px);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: var(--radius-xl);
    padding: var(--space-6);
    text-align: center;
    cursor: pointer;
    transition: all var(--transition-normal);
    position: relative;
  }
  
  .crm-option:hover {
    border-color: var(--primary-purple);
    transform: translateY(-2px);
    box-shadow: var(--shadow-soft);
  }
  
  .crm-option.selected {
    border-color: var(--primary-purple);
    background: rgba(109, 40, 217, 0.1);
  }
  
  .crm-option.selected::before {
    content: '✓';
    position: absolute;
    top: var(--space-3);
    right: var(--space-3);
    width: 24px;
    height: 24px;
    background: var(--primary-purple);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: var(--font-weight-bold);
  }
  
  .crm-icon {
    width: 64px;
    height: 64px;
    border-radius: var(--radius-xl);
    background: var(--primary-purple);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    margin: 0 auto var(--space-4);
  }
  
  .crm-name {
    font-size: 1.25rem;
    font-weight: var(--font-weight-bold);
    margin: 0 0 var(--space-2) 0;
    color: var(--text-primary);
  }
  
  .crm-description {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin: 0 0 var(--space-4) 0;
    line-height: 1.5;
  }
  
  .crm-features {
    list-style: none;
    padding: 0;
    margin: 0;
    text-align: left;
  }
  
  .crm-features li {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-bottom: var(--space-1);
  }
  
  .crm-features li::before {
    content: '✓';
    color: var(--success-emerald);
    font-weight: var(--font-weight-bold);
  }
  
  .crm-status {
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    font-size: 0.625rem;
    font-weight: var(--font-weight-medium);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-top: var(--space-3);
  }
  
  .status-available {
    background: rgba(16, 185, 129, 0.2);
    color: var(--success-emerald);
    border: 1px solid rgba(16, 185, 129, 0.3);
  }
  
  .status-coming-soon {
    background: rgba(245, 158, 11, 0.2);
    color: var(--warning-amber);
    border: 1px solid rgba(245, 158, 11, 0.3);
  }
  
  .connection-form {
    background: var(--surface-glass);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: var(--radius-xl);
    padding: var(--space-6);
    margin-bottom: var(--space-8);
    display: none;
  }
  
  .connection-form.active {
    display: block;
  }
  
  .form-header {
    margin-bottom: var(--space-6);
  }
  
  .form-title {
    font-size: 1.5rem;
    font-weight: var(--font-weight-bold);
    margin: 0 0 var(--space-2) 0;
    color: var(--text-primary);
  }
  
  .form-subtitle {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin: 0;
  }
  
  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--space-4);
    margin-bottom: var(--space-6);
  }
  
  .form-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }
  
  .form-label {
    font-size: 0.875rem;
    font-weight: var(--font-weight-medium);
    color: var(--text-primary);
  }
  
  .form-input {
    padding: var(--space-3);
    background: var(--surface-glass);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: 0.875rem;
    backdrop-filter: blur(10px);
  }
  
  .form-input:focus {
    outline: none;
    border-color: var(--primary-purple);
    box-shadow: 0 0 0 3px rgba(109, 40, 217, 0.1);
  }
  
  .form-select {
    padding: var(--space-3);
    background: var(--surface-glass);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: 0.875rem;
    backdrop-filter: blur(10px);
  }
  
  .form-select:focus {
    outline: none;
    border-color: var(--primary-purple);
  }
  
  .test-connection {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-3);
    background: var(--surface-glass);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: var(--radius-lg);
    margin-bottom: var(--space-4);
  }
  
  .test-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--primary-purple);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 0.875rem;
  }
  
  .test-content h4 {
    margin: 0;
    font-size: 0.875rem;
    font-weight: var(--font-weight-bold);
    color: var(--text-primary);
  }
  
  .test-content p {
    margin: 0;
    font-size: 0.75rem;
    color: var(--text-secondary);
  }
  
  .test-button {
    margin-left: auto;
    padding: var(--space-2) var(--space-3);
    background: var(--primary-purple);
    border: none;
    border-radius: var(--radius-sm);
    color: white;
    font-size: 0.75rem;
    font-weight: var(--font-weight-medium);
    cursor: pointer;
    transition: all var(--transition-fast);
  }
  
  .test-button:hover {
    background: var(--primary-purple-hover);
  }
  
  .mapping-section {
    background: var(--surface-glass);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: var(--radius-lg);
    padding: var(--space-4);
    margin-top: var(--space-4);
  }
  
  .mapping-title {
    font-size: 1rem;
    font-weight: var(--font-weight-bold);
    margin: 0 0 var(--space-3) 0;
    color: var(--text-primary);
  }
  
  .mapping-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-3);
  }
  
  .mapping-item {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }
  
  .mapping-label {
    font-size: 0.75rem;
    font-weight: var(--font-weight-medium);
    color: var(--text-secondary);
  }
  
  .mapping-select {
    padding: var(--space-2);
    background: var(--surface-glass);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    font-size: 0.75rem;
  }
  
  .completion-summary {
    background: linear-gradient(135deg, var(--primary-purple), var(--electric-violet));
    border-radius: var(--radius-xl);
    padding: var(--space-8);
    text-align: center;
    color: white;
    margin-bottom: var(--space-8);
  }
  
  .completion-icon {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    margin: 0 auto var(--space-4);
  }
  
  .completion-title {
    font-size: 2rem;
    font-weight: var(--font-weight-bold);
    margin: 0 0 var(--space-2) 0;
  }
  
  .completion-subtitle {
    font-size: 1.125rem;
    margin: 0 0 var(--space-6) 0;
    opacity: 0.9;
  }
  
  .completion-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: var(--space-4);
    margin-bottom: var(--space-6);
  }
  
  .stat-item {
    text-align: center;
  }
  
  .stat-value {
    font-size: 1.5rem;
    font-weight: var(--font-weight-bold);
    margin: 0 0 var(--space-1) 0;
  }
  
  .stat-label {
    font-size: 0.875rem;
    opacity: 0.8;
    margin: 0;
  }
  
  .setup-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: var(--space-4);
  }
  
  .btn-back {
    padding: var(--space-3) var(--space-6);
    background: var(--surface-glass);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: var(--radius-lg);
    color: var(--text-primary);
    text-decoration: none;
    font-size: 0.875rem;
    font-weight: var(--font-weight-medium);
    transition: all var(--transition-normal);
  }
  
  .btn-back:hover {
    background: var(--surface-glass-hover);
    border-color: rgba(255, 255, 255, 0.3);
  }
  
  .btn-complete {
    padding: var(--space-3) var(--space-6);
    background: var(--success-emerald);
    border: none;
    border-radius: var(--radius-lg);
    color: white;
    font-size: 0.875rem;
    font-weight: var(--font-weight-medium);
    cursor: pointer;
    transition: all var(--transition-normal);
  }
  
  .btn-complete:hover {
    background: #059669;
    transform: translateY(-1px);
  }
  
  @media (max-width: 768px) {
    .crm-options {
      grid-template-columns: 1fr;
    }
    
    .form-grid {
      grid-template-columns: 1fr;
    }
    
    .mapping-grid {
      grid-template-columns: 1fr;
    }
    
    .completion-stats {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .setup-actions {
      flex-direction: column;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="setup-container">
  <!-- Header -->
  <div class="setup-header">
    <h1 class="setup-title">CRM Connection</h1>
    <p class="setup-subtitle">Connect your CRM to sync leads and automate follow-ups</p>
    
    <!-- Progress Bar -->
    <div class="progress-bar">
      <div class="progress-fill"></div>
    </div>
    
    <!-- Step Indicator -->
    <div class="step-indicator">
      <div class="step-item completed">
        <div class="step-number">1</div>
        <span>Company Profile</span>
      </div>
      <div class="step-item completed">
        <div class="step-number">2</div>
        <span>Property Upload</span>
      </div>
      <div class="step-item completed">
        <div class="step-number">3</div>
        <span>AI Agent</span>
      </div>
      <div class="step-item active">
        <div class="step-number">4</div>
        <span>CRM Connection</span>
      </div>
    </div>
  </div>
  
  <!-- CRM Options -->
  <div class="crm-options">
    <div class="crm-option selected" data-crm="builtin">
      <div class="crm-icon">
        <i class="fas fa-database"></i>
      </div>
      <h3 class="crm-name">Built-in KaTek CRM</h3>
      <p class="crm-description">Use our integrated CRM system designed specifically for real estate</p>
      <ul class="crm-features">
        <li>Lead management & tracking</li>
        <li>Automated follow-ups</li>
        <li>Property matching</li>
        <li>Analytics & reporting</li>
      </ul>
      <div class="crm-status status-available">Recommended</div>
    </div>
    
    <div class="crm-option" data-crm="zoho">
      <div class="crm-icon">
        <i class="fas fa-building"></i>
      </div>
      <h3 class="crm-name">Zoho CRM</h3>
      <p class="crm-description">Connect to your existing Zoho CRM for seamless lead synchronization</p>
      <ul class="crm-features">
        <li>Real-time lead sync</li>
        <li>Custom field mapping</li>
        <li>Automated workflows</li>
        <li>Two-way data sync</li>
      </ul>
      <div class="crm-status status-available">Available</div>
    </div>
    
    <div class="crm-option" data-crm="hubspot">
      <div class="crm-icon">
        <i class="fas fa-chart-line"></i>
      </div>
      <h3 class="crm-name">HubSpot</h3>
      <p class="crm-description">Integrate with HubSpot for advanced marketing automation</p>
      <ul class="crm-features">
        <li>Lead scoring</li>
        <li>Email sequences</li>
        <li>Deal tracking</li>
        <li>Marketing automation</li>
      </ul>
      <div class="crm-status status-available">Available</div>
    </div>
    
    <div class="crm-option" data-crm="mailchimp">
      <div class="crm-icon">
        <i class="fas fa-envelope"></i>
      </div>
      <h3 class="crm-name">Mailchimp</h3>
      <p class="crm-description">Sync leads with Mailchimp for email marketing campaigns</p>
      <ul class="crm-features">
        <li>Email list sync</li>
        <li>Segmentation</li>
        <li>Campaign automation</li>
        <li>Analytics integration</li>
      </ul>
      <div class="crm-status status-available">Available</div>
    </div>
  </div>
  
  <!-- Zoho Connection Form -->
  <div class="connection-form" id="zoho-form">
    <div class="form-header">
      <h3 class="form-title">Zoho CRM Connection</h3>
      <p class="form-subtitle">Enter your Zoho credentials to sync leads automatically</p>
    </div>
    
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="crm_type" value="zoho">
      
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">Zoho Domain</label>
          <input type="text" name="zoho_domain" class="form-input" placeholder="yourcompany.zoho.com" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">Client ID</label>
          <input type="text" name="client_id" class="form-input" placeholder="Enter your Zoho Client ID" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">Client Secret</label>
          <input type="password" name="client_secret" class="form-input" placeholder="Enter your Zoho Client Secret" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">Refresh Token</label>
          <input type="text" name="refresh_token" class="form-input" placeholder="Enter your Zoho Refresh Token" required>
        </div>
      </div>
      
      <div class="test-connection">
        <div class="test-icon">
          <i class="fas fa-plug"></i>
        </div>
        <div class="test-content">
          <h4>Test Connection</h4>
          <p>Verify your credentials before saving</p>
        </div>
        <button type="button" class="test-button" onclick="testConnection()">Test</button>
      </div>
      
      <div class="mapping-section">
        <h4 class="mapping-title">Field Mapping</h4>
        <div class="mapping-grid">
          <div class="mapping-item">
            <label class="mapping-label">Email Field</label>
            <select name="email_field" class="mapping-select">
              <option value="Email">Email</option>
              <option value="Contact_Email">Contact Email</option>
              <option value="Lead_Email">Lead Email</option>
            </select>
          </div>
          
          <div class="mapping-item">
            <label class="mapping-label">Phone Field</label>
            <select name="phone_field" class="mapping-select">
              <option value="Phone">Phone</option>
              <option value="Mobile">Mobile</option>
              <option value="Contact_Phone">Contact Phone</option>
            </select>
          </div>
          
          <div class="mapping-item">
            <label class="mapping-label">Name Field</label>
            <select name="name_field" class="mapping-select">
              <option value="Full_Name">Full Name</option>
              <option value="First_Name">First Name</option>
              <option value="Lead_Name">Lead Name</option>
            </select>
          </div>
        </div>
      </div>
    </form>
  </div>
  
  <!-- HubSpot Connection Form -->
  <div class="connection-form" id="hubspot-form">
    <div class="form-header">
      <h3 class="form-title">HubSpot Connection</h3>
      <p class="form-subtitle">Connect to your HubSpot account for lead synchronization</p>
    </div>
    
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="crm_type" value="hubspot">
      
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">HubSpot Portal ID</label>
          <input type="text" name="portal_id" class="form-input" placeholder="Enter your HubSpot Portal ID" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">Private App Token</label>
          <input type="password" name="private_token" class="form-input" placeholder="Enter your Private App Token" required>
        </div>
      </div>
      
      <div class="test-connection">
        <div class="test-icon">
          <i class="fas fa-plug"></i>
        </div>
        <div class="test-content">
          <h4>Test Connection</h4>
          <p>Verify your credentials before saving</p>
        </div>
        <button type="button" class="test-button" onclick="testConnection()">Test</button>
      </div>
    </form>
  </div>
  
  <!-- Mailchimp Connection Form -->
  <div class="connection-form" id="mailchimp-form">
    <div class="form-header">
      <h3 class="form-title">Mailchimp Connection</h3>
      <p class="form-subtitle">Connect to your Mailchimp account for email marketing</p>
    </div>
    
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="crm_type" value="mailchimp">
      
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">API Key</label>
          <input type="password" name="api_key" class="form-input" placeholder="Enter your Mailchimp API Key" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">List ID</label>
          <input type="text" name="list_id" class="form-input" placeholder="Enter your Mailchimp List ID" required>
        </div>
      </div>
      
      <div class="test-connection">
        <div class="test-icon">
          <i class="fas fa-plug"></i>
        </div>
        <div class="test-content">
          <h4>Test Connection</h4>
          <p>Verify your credentials before saving</p>
        </div>
        <button type="button" class="test-button" onclick="testConnection()">Test</button>
      </div>
    </form>
  </div>
  
  <!-- Completion Summary -->
  <div class="completion-summary">
    <div class="completion-icon">
      <i class="fas fa-check"></i>
    </div>
    <h2 class="completion-title">Setup Complete!</h2>
    <p class="completion-subtitle">Your AI agent is ready to start converting leads into clients</p>
    
    <div class="completion-stats">
      <div class="stat-item">
        <div class="stat-value">87</div>
        <div class="stat-label">Properties Imported</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">24.5%</div>
        <div class="stat-label">Expected Conversion</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">2.3s</div>
        <div class="stat-label">Avg Response Time</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">Ready</div>
        <div class="stat-label">AI Agent Status</div>
      </div>
    </div>
  </div>
  
  <!-- Actions -->
  <div class="setup-actions">
    <a href="{% url 'setup_wizard' %}?step=3" class="btn-back">
      <i class="fas fa-arrow-left"></i>
      Back to AI Agent
    </a>
    <button type="submit" class="btn-complete" onclick="completeSetup()">
      <i class="fas fa-rocket"></i>
      Launch Your AI Agent
    </button>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // CRM option selection
  const crmOptions = document.querySelectorAll('.crm-option');
  const connectionForms = document.querySelectorAll('.connection-form');
  
  crmOptions.forEach(option => {
    option.addEventListener('click', function() {
      // Remove selected class from all options
      crmOptions.forEach(opt => opt.classList.remove('selected'));
      // Add selected class to clicked option
      this.classList.add('selected');
      
      // Hide all forms
      connectionForms.forEach(form => form.classList.remove('active'));
      
      // Show corresponding form if not builtin
      const crmType = this.dataset.crm;
      if (crmType !== 'builtin') {
        const form = document.getElementById(crmType + '-form');
        if (form) {
          form.classList.add('active');
        }
      }
    });
  });
});

function testConnection() {
  const button = event.target;
  const originalText = button.textContent;
  
  button.textContent = 'Testing...';
  button.disabled = true;
  
  // Simulate connection test
  setTimeout(() => {
    button.textContent = 'Connected ✓';
    button.style.background = 'var(--success-emerald)';
    
    setTimeout(() => {
      button.textContent = originalText;
      button.disabled = false;
      button.style.background = 'var(--primary-purple)';
    }, 2000);
  }, 1500);
}

function completeSetup() {
  // Show success message
  showToast('Setup complete! Your AI agent is now live and ready to convert leads.', 'success');
  
  // Redirect to dashboard after a short delay
  setTimeout(() => {
    window.location.href = '{% url "dashboard" %}';
  }, 2000);
}

function showToast(message, type) {
  const toast = document.createElement('div');
  toast.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--primary-purple);
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 14px;
    z-index: 1000;
    animation: slideIn 0.3s ease;
  `;
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.remove();
  }, 3000);
}
</script>
{% endblock %}
