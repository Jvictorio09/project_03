{% extends 'base.html' %}
{% load static %}

{% block title %}Login - KaTek AI{% endblock %}

{% block extra_css %}
<style>
/* ===== Design Tokens (uses your existing vars, with a few safe fallbacks) ===== */
:root{
  --kd-max: 1200px;
  --kd-ink: var(--deep-navy, #0b0e14);
  --kd-ink-2: #101523;
  --kd-ink-3: #0f1320;
  --kd-purple: var(--primary-purple, #6d28d9);
  --kd-violet: var(--electric-violet, #8b5cf6);
  --kd-aqua: #18afab;
  --kd-text: var(--text-primary, #f7f8fc);
  --kd-text-2: var(--text-secondary, #b9bfd4);
  --kd-muted: var(--text-muted, #9aa3b2);
  --kd-glass: var(--surface-glass, rgba(255,255,255,.04));
  --kd-glass-2: rgba(255,255,255,.06);
  --kd-brd: rgba(255,255,255,.14);
  --kd-brd-2: rgba(255,255,255,.24);
  --kd-r-lg: var(--radius-2xl, 22px);
  --kd-r-md: var(--radius-md, 12px);
  --kd-s-1: var(--space-4, 1rem);
  --kd-s-2: var(--space-6, 1.5rem);
  --kd-s-3: var(--space-8, 2rem);
  --kd-s-4: var(--space-10, 2.5rem);
}

/* ===== Stage (Aurora + Noise + Orbs) ===== */
.login-stage{
  min-height: 100vh;
  display: grid; place-items: center;
  padding: var(--kd-s-4) var(--kd-s-2);
  background:
    radial-gradient(1200px 700px at 15% 10%, rgba(109,40,217,.18), transparent 60%),
    radial-gradient(1000px 600px at 85% 90%, rgba(24,175,171,.16), transparent 55%),
    linear-gradient(135deg, var(--kd-ink) 0%, var(--kd-ink-2) 50%, var(--kd-ink-3) 100%);
  position: relative;
  overflow: hidden;
}
.login-stage::before{
  /* aurora sweep */
  content:"";
  position:absolute; inset:-20%;
  background: conic-gradient(from 180deg at 50% 50%, rgba(139,92,246,.14), rgba(24,175,171,.12), rgba(139,92,246,.14));
  filter: blur(80px);
  opacity:.6;
  animation: aurora 18s linear infinite;
}
.login-stage::after{
  /* soft film grain for depth */
  content:"";
  position:absolute; inset:0;
  background-image: url("data:image/svg+xml;utf8,\
  <svg xmlns='http://www.w3.org/2000/svg' width='160' height='160' viewBox='0 0 160 160'>\
  <filter id='n'><feTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='2' stitchTiles='stitch'/><feColorMatrix values='0 0 0 0 0  0 0 0 0 0  0 0 0 0 0  0 0 0 .06 0'/></filter>\
  <rect width='100%' height='100%' filter='url(%23n)'/></svg>");
  mix-blend-mode: soft-light;
  opacity:.45;
  pointer-events:none;
}
@keyframes aurora{ to{ transform: rotate(360deg) } }

/* ===== Shell Layout ===== */
.login-shell{
  width: 100%;
  max-width: var(--kd-max);
  display: grid;
  grid-template-columns: 1.05fr .95fr;
  gap: 2.25rem;
  position: relative;
}

/* ===== Brand Panel ===== */
.brand-card{
  background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00));
  border: 1px solid var(--kd-brd);
  border-radius: var(--kd-r-lg);
  padding: clamp(1.75rem, 3vw, 2.5rem);
  position: relative;
  overflow: hidden;
  min-height: 560px;
  display:flex; flex-direction:column; justify-content:space-between;
}
.brand-card::before{
  /* gradient border halo */
  content:"";
  position:absolute; inset: -1px;
  padding: 1px; border-radius: inherit;
  background: linear-gradient(135deg, rgba(109,40,217,.6), rgba(24,175,171,.35));
  -webkit-mask: 
    linear-gradient(#000 0 0) content-box, 
    linear-gradient(#000 0 0);
  -webkit-mask-composite: xor; 
  mask: 
    linear-gradient(#000 0 0) content-box, 
    linear-gradient(#000 0 0);
  mask-composite: exclude;
  pointer-events:none; opacity:.65;
}
.brand-card::after{
  /* orb */
  content:"";
  position:absolute; right:-12%; bottom:-10%;
  width: 360px; height: 360px; border-radius: 50%;
  background: radial-gradient(closest-side, rgba(139,92,246,.18), transparent 70%);
  filter: blur(8px);
}
.brand-logo{
  width: 64px; height: 64px; border-radius: 18px;
  display:grid; place-items:center; color:#fff;
  background: linear-gradient(135deg, var(--kd-purple), var(--kd-violet));
  box-shadow: 0 18px 50px rgba(109,40,217,.35);
}
.brand-headline{
  font-size: clamp(2rem, 3.6vw, 2.75rem);
  line-height: 1.1; letter-spacing:-.015em;
  background: linear-gradient(135deg, #fff, #d6d9ff 35%, #b7c0ff 60%, #cfa8ff 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip:text;
  margin-top: 1rem;
}
.brand-sub{
  color: var(--kd-text-2); font-size: clamp(1rem, 1.2vw, 1.125rem);
  margin-top:.75rem;
}
.brand-points{ margin-top: 1.25rem; display:grid; gap:.85rem; }
.point{
  display:flex; gap:.75rem; align-items:flex-start; color: var(--kd-text-2);
}
.point i{ color: var(--kd-violet); margin-top:.15rem; }
.trust-strip{
  margin-top: 1.5rem; opacity:.8;
  display:flex; gap:1.25rem; flex-wrap:wrap; align-items:center;
  color: var(--kd-muted); font-size:.9rem;
}
.trust-dot{ width:6px; height:6px; border-radius:50%; background: var(--kd-brd-2); }

/* ===== Login Card ===== */
.login-card{
  position: relative;
  overflow: hidden;
  border-radius: var(--kd-r-lg);
  background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
  border: 1px solid var(--kd-brd);
  padding: clamp(1.5rem, 2.6vw, 2.25rem);
  box-shadow: 0 12px 60px rgba(0,0,0,.45), 0 0 0 1px rgba(255,255,255,.03) inset;
}
.login-card::before{
  /* subtle inner glow top */
  content:""; position:absolute; inset:0 0 auto 0; height:30%;
  background: linear-gradient(180deg, rgba(139,92,246,.12), transparent);
  pointer-events:none;
}
.login-header{ text-align:center; margin-bottom: var(--kd-s-3); }
.login-badge{
  display:inline-flex; align-items:center; gap:.5rem;
  background: rgba(255,255,255,.04);
  border: 1px solid rgba(255,255,255,.12);
  padding: .35rem .6rem; border-radius: 999px; font-size:.75rem; color: var(--kd-text-2);
}
.login-title{ margin-top:.75rem; font-size:1.75rem; font-weight:800; letter-spacing:-.01em; }
.login-sub{ color: var(--kd-text-2); font-size:.95rem; }

/* ===== OAuth ===== */
.oauth{ display:flex; flex-direction:column; gap:.6rem; margin-top: var(--kd-s-2); }
.btn-oauth{
  display:flex; align-items:center; justify-content:center; gap:.6rem;
  padding: .9rem 1rem;
  border-radius: 14px;
  background: #fff; color:#1f2937;
  border: 1px solid #e5e7eb;
  transition: all .2s ease-out;
  box-shadow: 0 1px 3px rgba(0,0,0,.1), 0 1px 2px rgba(0,0,0,.06);
  position: relative;
  overflow: hidden;
  font-weight: 600;
}
.btn-oauth:hover{ 
  transform: translateY(-1px); 
  box-shadow: 0 4px 12px rgba(0,0,0,.15), 0 2px 4px rgba(0,0,0,.1);
  background: #f9fafb;
  border-color: #d1d5db;
}
.btn-oauth:active{ 
  transform: translateY(0);
  box-shadow: 0 1px 3px rgba(0,0,0,.1), 0 1px 2px rgba(0,0,0,.06);
}
.btn-oauth:focus{
  outline: none;
  ring: 2px;
  ring-color: #3b82f6;
  ring-opacity: 0.5;
}
.google-icon{
  flex-shrink: 0;
}
.oauth-disclaimer{
  font-size: .75rem; color: var(--kd-muted); text-align: center; margin-top: .5rem;
}
.btn-oauth.alt{
  background: var(--kd-glass); color: var(--kd-text);
  border: 1px solid var(--kd-brd-2);
}

/* ===== Divider ===== */
.hr{
  display:flex; align-items:center; gap: .75rem; margin: var(--kd-s-3) 0; color: var(--kd-muted); font-size:.85rem;
}
.hr::before,.hr::after{ content:""; flex:1; height:1px; background: rgba(255,255,255,.12); }

/* ===== Form ===== */
.form{ display:grid; gap: .9rem; }
.form .group{ position:relative; }
.label{ display:block; margin: 0 0 .35rem; font-size:.85rem; color: var(--kd-text-2); }

.field{
  position:relative; display:flex; align-items:center;
  border-radius: 14px;
  background: rgba(255,255,255,.04);
  border: 1px solid var(--kd-brd);
  padding: .95rem 1rem .95rem 2.6rem;
  transition: border-color .2s ease, box-shadow .2s ease, background .2s ease;
}
.field input{
  width:100%; background:transparent; border:none; outline:none; color: var(--kd-text); font-size:.98rem;
}
.f-icon{
  position:absolute; left:.8rem; width:1.2rem; display:grid; place-items:center; color: var(--kd-muted);
}
.f-addon{
  position:absolute; right:.5rem; display:flex; align-items:center; gap:.25rem;
}
.f-addon button{
  background:transparent; border:none; color: var(--kd-muted); cursor:pointer; padding:.25rem .45rem; border-radius: 8px;
}
.group.focus .field{
  border-color: rgba(139,92,246,.55);
  box-shadow: 0 0 0 4px rgba(139,92,246,.18);
  background: rgba(255,255,255,.06);
}
.hint{ margin-top:.35rem; font-size:.75rem; color: var(--kd-muted); }
.hint.warn{ color:#FFC36A; }

/* ===== Error slot ===== */
.error{
  display:none; margin: .25rem 0 var(--kd-s-2);
  padding: .75rem .875rem; border-radius: 12px;
  background: linear-gradient(180deg, rgba(255,82,82,.14), rgba(255,82,82,.08));
  border: 1px solid rgba(255,82,82,.35);
  color: #ff9c9c; font-size:.9rem;
}
.error.show{ display:block; }

/* ===== Actions ===== */
.row-aux{
  display:flex; justify-content:space-between; align-items:center; gap:1rem; margin-top:.25rem;
  color: var(--kd-text-2); font-size:.9rem;
}
.row-aux a{ color: var(--kd-violet); text-decoration:none; }
.row-aux a:hover{ text-decoration: underline; }

/* Fix button alignment and styling */
.btn-primary {
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  text-align: center !important;
  vertical-align: middle !important;
  line-height: 1 !important;
  padding: var(--space-3) var(--space-6) !important;
  min-height: 36px !important;
  height: auto !important;
}

.btn-ghost {
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  text-align: center !important;
  vertical-align: middle !important;
  line-height: 1 !important;
  padding: var(--space-3) var(--space-6) !important;
  min-height: 36px !important;
  height: auto !important;
}

.footer{
  margin-top: var(--kd-s-3); padding-top: var(--kd-s-2);
  border-top:1px solid rgba(255,255,255,.1);
  text-align:center; color: var(--kd-text-2); font-size:.9rem;
}
.footer a{ color: var(--kd-violet); }

/* ===== Reduced motion ===== */
@media (prefers-reduced-motion: reduce){
  .btn-primary, .btn-oauth{ transition:none !important; }
  .login-stage::before{ animation: none; }
}

/* ===== Responsive ===== */
@media (max-width: 980px){
  .login-shell{ grid-template-columns: 1fr; }
  .brand-card{ order:2; min-height: auto; }
  .login-card{ order:1; }
}
</style>
{% endblock %}

{% block content %}
{# Safe URL guards so missing routes don't crash the template #}
{% url 'password_reset' as password_reset_url %}
{% url 'signup' as signup_url %}

<div class="login-stage">
  <div class="login-shell">
    <!-- Brand Panel -->
    <section class="brand-card">
      <div>
        <div class="brand-logo" aria-hidden="true"><i class="fas fa-home"></i></div>
        <h1 class="brand-headline">Turn logins into loyalty.</h1>
        <p class="brand-sub">KaTek AI gives brokerages a concierge-level experience from the very first sign-in—fast, personal, and beautiful.</p>

        <div class="brand-points">
          <!-- Font Awesome 6 Free-safe icons -->
          <div class="point"><i class="fas fa-wand-magic-sparkles"></i><span>Luxury glass UI with instant, accessible interactions.</span></div>
          <div class="point"><i class="fas fa-bolt"></i><span>SSO-ready. Seamless Google in one click.</span></div>
          <div class="point"><i class="fas fa-shield-halved"></i><span>Hardened auth: rate-limits, CSRF, and session lock.</span></div>
        </div>
      </div>

      <div>
        <div class="trust-strip">
          <span class="trust-dot"></span> Trusted by 2,400+ brokers
          <span class="trust-dot"></span> 99.98% uptime
          <span class="trust-dot"></span> SOC-friendly practices
        </div>
      </div>
    </section>

    <!-- Login Card -->
    <section class="login-card">
      <header class="login-header">
        <span class="login-badge"><i class="fas fa-circle-check"></i> Secure Sign-In</span>
        <h2 class="login-title">Welcome back</h2>
        <p class="login-sub">Sign in to your KaTek AI account</p>
      </header>

      {% if form.errors %}
        <div class="error show" role="alert">
          {% for field, errors in form.errors.items %}
            {% for e in errors %}{{ e }}{% endfor %}
          {% endfor %}
        </div>
      {% endif %}
      {% if messages %}
        <div class="error show" role="alert">
          {% for message in messages %}{{ message }}{% endfor %}
        </div>
      {% endif %}

      <form method="post" class="form" novalidate>
        {% csrf_token %}

        <!-- OAuth -->
        <div class="oauth">
          <a href="{% url 'google_oauth_login' %}" class="btn-oauth" aria-label="Continue with Google">
            <svg class="google-icon" width="20" height="20" viewBox="0 0 24 24">
              <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            Continue with Google
          </a>
          <p class="oauth-disclaimer">We'll never post without your permission.</p>
        </div>

        <div class="hr">or sign in with email</div>

        <!-- Email -->
        <div class="group">
          <label class="label" for="{{ form.username.id_for_label }}">{{ form.username.label }}</label>
          <div class="field">
            <span class="f-icon"><i class="fas fa-envelope"></i></span>
            {{ form.username }}
            <div class="f-addon" aria-hidden="true"></div>
          </div>
          <div class="hint">Use your admin or invited email.</div>
        </div>

        <!-- Password -->
        <div class="group">
          <label class="label" for="{{ form.password.id_for_label }}">{{ form.password.label }}</label>
          <div class="field">
            <span class="f-icon"><i class="fas fa-lock"></i></span>
            {{ form.password }}
            <div class="f-addon">
              <button type="button" id="toggle-pass" aria-label="Show password" title="Show/Hide"><i class="fas fa-eye"></i></button>
            </div>
          </div>
          <div class="hint" id="caps-hint" hidden>Caps Lock is on</div>
        </div>

        <div class="row-aux">
          <label style="display:flex;align-items:center;gap:.5rem;">
            {{ form.remember_me }} <span>Remember me</span>
          </label>
          <a href="{{ password_reset_url|default:'#' }}">Forgot password?</a>
        </div>

        <button id="submit-btn" type="submit" class="btn-primary">Sign In</button>
        <a href="{{ signup_url|default:'#' }}" class="btn-ghost">Don't have an account? Sign up</a>
      </form>

      <div class="footer">
        By continuing, you agree to our <a href="#">Terms</a> & <a href="#">Privacy</a>.
      </div>
    </section>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function(){
  // focus styling
  document.querySelectorAll('.form-input').forEach(el=>{
    el.addEventListener('focus', ()=> el.closest('.group')?.classList.add('focus'));
    el.addEventListener('blur',  ()=> el.closest('.group')?.classList.remove('focus'));
  });

  // show/hide password
  const pass = document.querySelector('input[name="password"]');
  const toggle = document.getElementById('toggle-pass');
  toggle?.addEventListener('click', ()=>{
    const show = pass.type === 'password';
    pass.type = show ? 'text' : 'password';
    toggle.setAttribute('aria-label', show ? 'Hide password' : 'Show password');
    toggle.innerHTML = show ? '<i class="fas fa-eye-slash"></i>' : '<i class="fas fa-eye"></i>';
    pass.focus({preventScroll:true});
  });

  // caps lock hint
  const capsHint = document.getElementById('caps-hint');
  const setCaps = (e)=>{
    const on = e.getModifierState && e.getModifierState('CapsLock');
    if(!capsHint) return;
    capsHint.hidden = !on;
    capsHint.classList.toggle('warn', on);
  };
  pass?.addEventListener('keyup', setCaps);
  pass?.addEventListener('keydown', setCaps);

  // submit button micro-state
  const form = document.querySelector('.form');
  const submit = document.getElementById('submit-btn');
  form?.addEventListener('submit', ()=>{
    if(!submit) return;
    submit.disabled = true;
    submit.style.opacity = .92;
    submit.textContent = 'Signing in…';
    setTimeout(()=>{ submit.disabled = false; submit.textContent = 'Sign In'; submit.style.opacity = 1; }, 7000);
  });
});
</script>
{% endblock %}
