<!-- AI Chatbox Interface -->
<div class="space-y-4">
    <!-- Chat Header -->
    <div class="flex items-center justify-between pb-3 border-b border-gray-200">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-orange-500 flex items-center justify-center text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                </svg>
            </div>
            <div>
                <h3 class="font-semibold text-gray-900">AI Property Assistant</h3>
                <p class="text-xs text-gray-500">Finding your perfect home</p>
            </div>
        </div>
        <button onclick="location.reload()" class="text-gray-400 hover:text-gray-600">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    </div>

    <!-- Chat Messages Container -->
    <div id="chat-messages" class="space-y-4 max-h-96 overflow-y-auto p-4 bg-gray-50 rounded-xl">
        <!-- Initial user message -->
        <div class="flex justify-end mb-4">
            <div class="flex items-start gap-2 max-w-[80%]">
                <div class="rounded-2xl px-4 py-3 bg-orange-500 text-white">
                    <p class="text-sm leading-relaxed whitespace-pre-line">{{ initial_message }}</p>
                </div>
                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-gray-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                </div>
            </div>
        </div>

        <!-- AI response -->
        <div class="flex justify-start mb-4">
            <div class="flex items-start gap-2 max-w-[80%]">
                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-orange-500 flex items-center justify-center text-white">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                </div>
                <div class="rounded-2xl px-4 py-3 bg-gray-100 text-gray-900">
                    <p class="text-sm leading-relaxed whitespace-pre-line">{{ ai_response|linebreaksbr }}</p>
                </div>
            </div>
        </div>

        <!-- New messages will be appended here -->
        <div id="new-messages"></div>
        
        <!-- Loading indicator -->
        <div id="loading-indicator" class="hidden flex justify-start mb-4">
            <div class="flex items-start gap-2 max-w-[80%]">
                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-orange-500 flex items-center justify-center text-white">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                </div>
                <div class="rounded-2xl px-4 py-3 bg-gray-100 text-gray-900">
                    <div class="flex items-center gap-2">
                        <div class="flex gap-1">
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                        </div>
                        <span class="text-xs text-gray-500">Thinking...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Input Form -->
    <form id="chat-form"
          hx-post="{% url 'webhook_chat' %}"
          hx-target="#new-messages"
          hx-swap="beforeend"
          hx-on::after-request="document.getElementById('chat-input').value=''; document.getElementById('loading-indicator').classList.add('hidden'); document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;"
          class="flex gap-2">
        {% csrf_token %}
        <input type="text"
               id="chat-input"
               name="message"
               placeholder="Ask me anything about properties..."
               class="flex-1 px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-orange-500 focus:border-transparent text-gray-900"
               required
               autocomplete="off">
        <button type="submit"
                class="px-6 py-3 bg-orange-600 text-white rounded-xl hover:bg-orange-700 transition flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
            </svg>
            Send
        </button>
    </form>

    <!-- Also display user message in chat before AI responds -->
    <script>
        document.getElementById('chat-form').addEventListener('htmx:beforeRequest', function(evt) {
            const message = document.getElementById('chat-input').value;
            const timestamp = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            
            // Add user message to chat
            const userMessageHTML = `
                <div class="flex justify-end mb-4">
                    <div class="flex items-start gap-2 max-w-[80%]">
                        <div class="rounded-2xl px-4 py-3 bg-orange-500 text-white">
                            <p class="text-sm leading-relaxed whitespace-pre-line">${message}</p>
                            <span class="text-xs text-orange-100 mt-1 block">${timestamp}</span>
                        </div>
                        <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-gray-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('new-messages').insertAdjacentHTML('beforeend', userMessageHTML);
            
            // Show loading indicator
            document.getElementById('loading-indicator').classList.remove('hidden');
            
            // Scroll to bottom
            document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
        });
        
        // Auto-scroll on page load
        setTimeout(() => {
            document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
        }, 100);
        
        // Property title auto-linking functionality
        let propertyTitles = [];
        
        // Fetch property titles from API
        async function fetchPropertyTitles() {
            try {
                const response = await fetch('/api/properties/titles/');
                const data = await response.json();
                propertyTitles = data.properties || [];
                console.log('Loaded property titles:', propertyTitles.length);
            } catch (error) {
                console.error('Error fetching property titles:', error);
            }
        }
        
        // Scan message for property titles and add links
        function linkifyPropertyTitles(messageElement) {
            if (!messageElement || propertyTitles.length === 0) return;
            
            const textElement = messageElement.querySelector('p');
            if (!textElement) return;
            
            const messageText = textElement.textContent;
            const foundProperties = [];
            
            // Find all matching property titles in the message
            propertyTitles.forEach(property => {
                if (messageText.includes(property.title)) {
                    foundProperties.push(property);
                }
            });
            
            // If properties found, add clickable links below the message
            if (foundProperties.length > 0) {
                const linksContainer = document.createElement('div');
                linksContainer.className = 'mt-3 space-y-2';
                
                foundProperties.forEach(property => {
                    const linkElement = document.createElement('a');
                    linkElement.href = `/property/${property.slug}/`;
                    linkElement.target = '_blank';
                    linkElement.className = 'flex items-center gap-2 px-3 py-2 bg-orange-50 hover:bg-orange-100 text-orange-700 rounded-lg transition-colors border border-orange-200 text-xs font-medium';
                    linkElement.innerHTML = `
                        <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                        </svg>
                        <span class="flex-1">View: ${property.title}</span>
                        <svg class="w-3 h-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                        </svg>
                    `;
                    linksContainer.appendChild(linkElement);
                });
                
                // Insert links after the message text
                messageElement.appendChild(linksContainer);
            }
        }
        
        // Process AI messages after they're added
        document.getElementById('chat-form').addEventListener('htmx:afterSwap', function(evt) {
            // Get the newly added AI message
            const newMessages = document.getElementById('new-messages');
            const lastMessage = newMessages.lastElementChild;
            
            if (lastMessage && lastMessage.querySelector('.bg-gray-100')) {
                // This is an AI message, scan for property titles
                const messageContainer = lastMessage.querySelector('.bg-gray-100');
                linkifyPropertyTitles(messageContainer);
            }
            
            // Scroll to bottom
            setTimeout(() => {
                document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
            }, 100);
        });
        
        // Fetch property titles and process messages on page load
        fetchPropertyTitles().then(() => {
            console.log('Property titles loaded, processing initial message...');
            // Process initial AI message
            const initialAIMessage = document.querySelector('.bg-gray-100');
            if (initialAIMessage) {
                linkifyPropertyTitles(initialAIMessage);
            }
        });
    </script>
</div>
